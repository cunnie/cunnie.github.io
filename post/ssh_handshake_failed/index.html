<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Troubleshooting Obscure OpenSSH Failures | Brian Cunnie's Technical Blog</title><meta name=keywords content><meta name=description content="Abstract By using tcpdump to troubleshoot an elusive error, we uncovered a man-in-the-middle (MITM) ssh proxy installed by our information security (InfoSec) team to harden/protect a set of machines which were accessible from the internet. The ssh proxy in question was Palo Alto Network’s (PAN) Layer 7 (i.e. it worked on any port, not solely ssh’s port 22) proxy, and was discovered when we observed a failure to negotiate ciphers during the ssh key exchange."><meta name=author content="Brian Cunnie"><link rel=canonical href=https://blog.nono.io/post/ssh_handshake_failed/><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.nono.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.nono.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.nono.io/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.nono.io/apple-touch-icon.png><link rel=mask-icon href=https://blog.nono.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-0NJ11E527T"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-0NJ11E527T",{anonymize_ip:!1})}</script><meta property="og:title" content="Troubleshooting Obscure OpenSSH Failures"><meta property="og:description" content="Abstract By using tcpdump to troubleshoot an elusive error, we uncovered a man-in-the-middle (MITM) ssh proxy installed by our information security (InfoSec) team to harden/protect a set of machines which were accessible from the internet. The ssh proxy in question was Palo Alto Network’s (PAN) Layer 7 (i.e. it worked on any port, not solely ssh’s port 22) proxy, and was discovered when we observed a failure to negotiate ciphers during the ssh key exchange."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.nono.io/post/ssh_handshake_failed/"><meta property="og:image" content="https://nono.io/images/brian_cunnie_profile.jpg"><meta property="article:section" content="post"><meta property="article:published_time" content="2018-11-28T17:16:22+00:00"><meta property="article:modified_time" content="2018-11-28T17:16:22+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://nono.io/images/brian_cunnie_profile.jpg"><meta name=twitter:title content="Troubleshooting Obscure OpenSSH Failures"><meta name=twitter:description content="Abstract By using tcpdump to troubleshoot an elusive error, we uncovered a man-in-the-middle (MITM) ssh proxy installed by our information security (InfoSec) team to harden/protect a set of machines which were accessible from the internet. The ssh proxy in question was Palo Alto Network’s (PAN) Layer 7 (i.e. it worked on any port, not solely ssh’s port 22) proxy, and was discovered when we observed a failure to negotiate ciphers during the ssh key exchange."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.nono.io/post/"},{"@type":"ListItem","position":2,"name":"Troubleshooting Obscure OpenSSH Failures","item":"https://blog.nono.io/post/ssh_handshake_failed/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Troubleshooting Obscure OpenSSH Failures","name":"Troubleshooting Obscure OpenSSH Failures","description":"Abstract By using tcpdump to troubleshoot an elusive error, we uncovered a man-in-the-middle (MITM) ssh proxy installed by our information security (InfoSec) team to harden/protect a set of machines which were accessible from the internet. The ssh proxy in question was Palo Alto Network’s (PAN) Layer 7 (i.e. it worked on any port, not solely ssh’s port 22) proxy, and was discovered when we observed a failure to negotiate ciphers during the ssh key exchange.","keywords":[],"articleBody":"Abstract By using tcpdump to troubleshoot an elusive error, we uncovered a man-in-the-middle (MITM) ssh proxy installed by our information security (InfoSec) team to harden/protect a set of machines which were accessible from the internet. The ssh proxy in question was Palo Alto Network’s (PAN) Layer 7 (i.e. it worked on any port, not solely ssh’s port 22) proxy, and was discovered when we observed a failure to negotiate ciphers during the ssh key exchange.\nThe Problem In our team’s [Concourse CI] (continuous integration) pipelines, we create new PCF Pivotal Cloud Foundry environments, subject them to a rigorous battery of tests, and then destroy them. Among our tests is the Container Networking Acceptance test suite (NATS or CNATS—not to be confused with the NATS messaging bus), which runs many cf ssh commands to test app-to-app connectivity.\nThe error was elusive, but inconvenient — it would cause an entire test suite to fail. Our only clue was a cryptic ssh failure:\nError opening SSH connection: ssh: handshake failed: EOF Let’s be clear: we’re not using OpenSSH in our tests. Sure, we’re using the SSH protocol as implemented by the Golang library, but we’re not using the command line tool which so many of us know and love. In other words, we type cf ssh instead of ssh.\nThe purpose of this specialized implementation of the OpenSSH protocol is to allow users of our Pivotal Application Service (PAS) software to connect to their application, typically to debug.\nOnce again, though, it’s not quite OpenSSH. For one thing, our server-side binds to port 2222, not sshd’s 22. Also, it’s written in Golang, not C (both the client and the server).\nDefining the problem The problem wasn’t consistent. In fact, over the course of a 20-minute test run, it would only appear once.\nIt didn’t appear everywhere—one of our environments, maintained in San Francisco, seemed immune to the problem. In fact, the problem reared its ugly head only in our San Jose environments.\nAnd, strangest of all, the problem only occurred on the first connection attempt. The first time cf ssh was run, it would fail, but subsequent attempts succeeded.\nWe attempted connecting from workstations in Palo Alto, San Francisco, and Santa Monica. The behavior remained consistent: the first attempt would fail, and the remaining would succeed.\nWe tried using ssh as a client instead of cf ssh. Same behavior: first would fail, remainder succeed.\nWe tried bringing up sshd as a server. The results surprised us: no failures. Not one. Our ssh-proxy failed, but sshd didn’t — what was going on?\nWe knew it was time for tcpdump. If we were going to get any further, we needed to examine the raw packets.\nUsing tcpdump on our Server We ran tcpdump on our server (the “Diego Brain”) to determine what was happening during failed cf ssh connections. We discovered that, from the Diego Brain’s perspective, the user was shutting down the connection (by sending a FIN packet).\nFrom the standpoint of the Diego brain (192.168.2.6), the user (10.80.130.32) terminates (FIN) the session immediately after key exchange negotiation\nWe dug deeper — was there anything happening in the key exchange that caused the connection to shut down?\nYes, there was something happening: the client and the Diego Brain could not agree on a common set of ciphers.\nThese were the ciphers offered by the Diego Brain. Note that these ciphers are the ones included in Golang’s ssh package:\n“curve25519-sha256@libssh.org” “ecdh-sha2-nistp256” “ecdh-sha2-nistp384” “ecdh-sha2-nistp521” “diffie-hellman-group14-sha1” “diffie-hellman-group1-sha1” These were the ciphers offered by the client:\n“diffie-hellman-group-exchange-sha256” “diffie-hellman-group-exchange-sha1” We believe that the client shut down the connection because it could not agree on a common cipher for key exchange. But the client and server were both written in Golang, so their cipher suites should be identical. In fact, both Diffie Hellman group exchange ciphers are explicitly considered to be legacy protocols by the Golang maintainers. Why was the client’s cipher suite different, and why did it include legacy protocols?\nAt this point we also noticed that the SSH protocol was unexpected: it was SSH-2.0-PaloAltoNetworks_0.2. We decided to trace the packets from the client.\nUsing tcpdump on our Client We ran tcpdump on our client, and attempted to connect (via ssh, not our custom client, not cf ssh) to our Diego Brain. We found the unexpected SSH protocol again, SSH-2.0-PaloAltoNetworks_0.2, but this time it was our Diego Brain presenting it:\nA packet trace of an two attempted connections to port 2222; the first failed, and the second succeeded.\nBut the SSH protocol SSH-2.0-PaloAltoNetworks_0.2 was only presented when the connection subsequently failed. In the diagram above, we can see that the ostensible Diego Brain shut down the connection by sending a FIN packet (packet 19) to our client.\nIOPS to the Rescue We contacted IOPS, the Pivotal organization which maintains the network, who explained that the firewall is configured to intercept and proxy all ssh connections originating from or terminating at the San Jose datacenter in order to prevent ssh tunnel attacks, since the San Jose environments are accessible from the internet.\nOur Conclusions Our networking model was wrong:\nUnbeknownst to us, the Palo Alto Networks firewall was intercepting our ssh traffic.\nWe concluded that our cf ssh connection actually works this way:\nOur firewall attempts to proxy all ssh connections to San Jose. When it attempts to contact the backend, it realizes it doesn’t have a common cipher suite for key exchange, and can’t establish a connection When it can’t establish a connection with the server, it sends a FIN to the client (EOF) It proceeds to whitelist the client-IP, server-IP, server-port tuple for a little more than one hour [timeout]. It does not attempt to proxy during that time It will attempt to proxy new client connections from different IP addresses during that time Our final resolution to this issue was a workaround wherein each test suite that runs cf ssh, we “prime the pump” by running a cf ssh command, which we expect to fail, before running the test suite.\nFootnotes [timeout] The exact timeout is a little more than an hour, somewhere between 3720 and 3840 seconds.\nWe wrote a script to more precisely determine the timeout. As can be seen from the output below (edited for clarity), there was no proxy attempt at 3720 seconds (Permission denied...), but there was at 3840 seconds (Connection closed...)\nPermission denied (password). Timeout: 3720 Connection closed by 10.195.84.17 port 2222 Timeout: 3840 Corrections \u0026 Updates 2019-01-02\nInclude the amount of time that the PAN firewall waits after an unsuccessful proxy attempt before triggering the next attempt.\n","wordCount":"1097","inLanguage":"en","datePublished":"2018-11-28T17:16:22Z","dateModified":"2018-11-28T17:16:22Z","author":{"@type":"Person","name":"Brian Cunnie"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.nono.io/post/ssh_handshake_failed/"},"publisher":{"@type":"Organization","name":"Brian Cunnie's Technical Blog","logo":{"@type":"ImageObject","url":"https://blog.nono.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.nono.io/ accesskey=h title="Brian Cunnie's Technical Blog (Alt + H)">Brian Cunnie's Technical Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.nono.io/>Home</a>&nbsp;»&nbsp;<a href=https://blog.nono.io/post/>Posts</a></div><h1 class=post-title>Troubleshooting Obscure OpenSSH Failures</h1><div class=post-meta><span title='2018-11-28 17:16:22 +0000 UTC'>November 28, 2018</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;Brian Cunnie&nbsp;|&nbsp;<a href=https://github.com/cunnie/cunnie.github.io/tree/master/content/post/ssh_handshake_failed.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><h2 id=abstract>Abstract<a hidden class=anchor aria-hidden=true href=#abstract>#</a></h2><p>By using tcpdump to troubleshoot an elusive error, we uncovered a
man-in-the-middle (MITM) ssh proxy installed by our information security
(InfoSec) team to harden/protect a set of machines which were accessible
from the internet. The ssh proxy in question was Palo Alto Network’s
(PAN) Layer 7 (i.e. it worked on any port, not solely ssh’s port 22)
proxy, and was discovered when we observed a failure to negotiate
ciphers during the ssh key exchange.</p><h2 id=the-problem>The Problem<a hidden class=anchor aria-hidden=true href=#the-problem>#</a></h2><p>In our team&rsquo;s [Concourse CI] (continuous integration)
<a href=https://ci.nsx-t.cf-app.com/>pipelines</a>, we create new PCF <a href=https://en.wikipedia.org/wiki/Cloud_Foundry>Pivotal Cloud
Foundry</a> environments, subject them
to a rigorous battery of tests, and then destroy them. Among our tests is the
<a href=https://github.com/cloudfoundry/cf-networking-release/tree/develop/src/test/acceptance>Container Networking
Acceptance</a>
test suite (NATS or CNATS—not to be confused with the NATS messaging bus), which
runs many <code>cf ssh</code> commands to test app-to-app connectivity.</p><figure class=center><img loading=lazy src=https://user-images.githubusercontent.com/1020675/48293711-4366a480-e435-11e8-8d19-99d3b6aa0cb0.png></figure><p>The error was elusive, but inconvenient — it would cause an entire test suite to fail.
Our only clue was a cryptic ssh failure:</p><pre tabindex=0><code>Error opening SSH connection: ssh: handshake failed: EOF
</code></pre><p>Let&rsquo;s be clear: we&rsquo;re not using OpenSSH in our tests. Sure, we&rsquo;re using the SSH
protocol as implemented by the Golang library, but we&rsquo;re not using the command
line tool which so many of us know and love. In other words, we type <code>cf ssh</code>
instead of <code>ssh</code>.</p><p>The purpose of this <a href=https://github.com/cloudfoundry/diego-ssh/blob/0f5b562e00a3ca52b0fa67527a43325aa743d401/cmd/ssh-proxy/main.go#L196>specialized
implementation</a>
of the OpenSSH protocol is to allow users of our Pivotal Application Service
(PAS) software to connect to their application, typically to debug.</p><p>Once again, though, it&rsquo;s not quite OpenSSH. For one thing, our server-side binds
to port 2222, not <code>sshd</code>&rsquo;s 22. Also, it&rsquo;s written in Golang, not C (both the
client and the server).</p><h2 id=defining-the-problem>Defining the problem<a hidden class=anchor aria-hidden=true href=#defining-the-problem>#</a></h2><p>The problem wasn&rsquo;t consistent. In fact, over the course of a 20-minute test
run, it would only appear once.</p><p>It didn&rsquo;t appear everywhere—one of our environments, maintained in San
Francisco, seemed immune to the problem. In fact, the problem reared its ugly
head only in our San Jose environments.</p><p>And, strangest of all, the problem only occurred on the first connection
attempt. The first time <code>cf ssh</code> was run, it would fail, but subsequent
attempts succeeded.</p><p>We attempted connecting from workstations in Palo Alto, San Francisco, and Santa
Monica. The behavior remained consistent: the first attempt would fail, and the
remaining would succeed.</p><p>We tried using <code>ssh</code> as a client instead of <code>cf ssh</code>. Same behavior: first
would fail, remainder succeed.</p><p>We tried bringing up <code>sshd</code> as a server. The results surprised us: no failures.
Not one. Our <code>ssh-proxy</code> failed, but <code>sshd</code> didn&rsquo;t — what was going on?</p><p>We knew it was time for <code>tcpdump</code>. If we were going to get any further, we
needed to examine the raw packets.</p><h2 id=using-tcpdump-on-our-server>Using <code>tcpdump</code> on our Server<a hidden class=anchor aria-hidden=true href=#using-tcpdump-on-our-server>#</a></h2><p>We ran <code>tcpdump</code> on our server (the &ldquo;Diego Brain&rdquo;) to determine what
was happening during failed <code>cf ssh</code> connections. We discovered that, from the
Diego Brain&rsquo;s perspective, the user was shutting down the connection (by sending
a <code>FIN</code> packet).</p><figure class=center><img loading=lazy src=https://user-images.githubusercontent.com/1020675/49247572-9ead0680-f3e5-11e8-8952-c23f53106236.png alt="From the standpoint of the Diego brain (192.168.2.6), the user (10.80.130.32) terminates (FIN) the session immediately after key exchange negotiation"><figcaption><p>From the standpoint of the Diego brain (192.168.2.6), the user (10.80.130.32) terminates (FIN) the session immediately after key exchange negotiation</p></figcaption></figure><p>We dug deeper — was there anything happening in the key exchange that caused the
connection to shut down?</p><p>Yes, there was something happening: the client and the Diego Brain could not
agree on a common set of ciphers.</p><p>These were the ciphers offered by the Diego Brain. Note that these ciphers are
the ones included in Golang&rsquo;s <code>ssh</code> package:</p><ul><li>&ldquo;<a href=mailto:curve25519-sha256@libssh.org>curve25519-sha256@libssh.org</a>&rdquo;</li><li>&ldquo;ecdh-sha2-nistp256&rdquo;</li><li>&ldquo;ecdh-sha2-nistp384&rdquo;</li><li>&ldquo;ecdh-sha2-nistp521&rdquo;</li><li>&ldquo;diffie-hellman-group14-sha1&rdquo;</li><li>&ldquo;diffie-hellman-group1-sha1&rdquo;</li></ul><p>These were the ciphers offered by the client:</p><ul><li>&ldquo;diffie-hellman-group-exchange-sha256&rdquo;</li><li>&ldquo;diffie-hellman-group-exchange-sha1&rdquo;</li></ul><p>We believe that the client shut down the connection because it could not agree
on a common cipher for key exchange. But the client and server were both written
in Golang, so their cipher suites should be identical. In fact, both Diffie
Hellman group exchange ciphers are <a href=https://github.com/golang/go/issues/17230>explicitly considered to be legacy
protocols</a> by the Golang maintainers.
Why was the client&rsquo;s cipher suite different, and why did it include legacy
protocols?</p><p>At this point we also noticed that the SSH protocol was unexpected: it was
<code>SSH-2.0-PaloAltoNetworks_0.2</code>. We decided to trace the packets from the client.</p><h2 id=using-tcpdump-on-our-client>Using <code>tcpdump</code> on our Client<a hidden class=anchor aria-hidden=true href=#using-tcpdump-on-our-client>#</a></h2><p>We ran <code>tcpdump</code> on our client, and attempted to connect (via <code>ssh</code>, not our
custom client, not <code>cf ssh</code>) to our Diego Brain. We found the unexpected SSH
protocol again, <code>SSH-2.0-PaloAltoNetworks_0.2</code>, but this time it was our Diego
Brain presenting it:</p><figure class=center><img loading=lazy src=https://user-images.githubusercontent.com/1020675/48366291-3aa6e600-e662-11e8-9cba-d6e4ea989245.png alt="A packet trace of an two attempted connections to port 2222; the first failed, and the second succeeded."><figcaption><p>A packet trace of an two attempted connections to port 2222; the first failed, and the second succeeded.</p></figcaption></figure><p>But the SSH protocol <code>SSH-2.0-PaloAltoNetworks_0.2</code> was <em>only presented when the
connection subsequently failed</em>. In the diagram above, we can see that the
ostensible Diego Brain shut down the connection by sending a FIN packet (packet
19) to our client.</p><h2 id=iops-to-the-rescue>IOPS to the Rescue<a hidden class=anchor aria-hidden=true href=#iops-to-the-rescue>#</a></h2><p>We contacted IOPS, the Pivotal organization which maintains the network, who
explained that the firewall is configured to <strong>intercept and proxy all ssh
connections</strong> originating from or terminating at the San Jose datacenter in
order to prevent ssh tunnel attacks, since the San Jose environments are
accessible from the internet.</p><h2 id=our-conclusions>Our Conclusions<a hidden class=anchor aria-hidden=true href=#our-conclusions>#</a></h2><p>Our networking model was wrong:</p><figure class=center><img loading=lazy src="https://docs.google.com/drawings/d/e/2PACX-1vQ91WlZe49wqBc6AdjYCFaUXF-A5pPrHsthVVDCeJPJOVBifhxUy3-8oQ6TNvAL10qbGKSSbpkFwf95/pub?w=1568&amp;amp;h=1405" alt="Unbeknownst to us, the Palo Alto Networks firewall was intercepting our ssh traffic."><figcaption><p>Unbeknownst to us, the Palo Alto Networks firewall was intercepting our ssh traffic.</p></figcaption></figure><p>We concluded that our <code>cf ssh</code> connection <em>actually</em> works this way:</p><ul><li>Our firewall attempts to proxy all ssh connections to San Jose.</li><li>When it attempts to contact the backend, it realizes it doesn&rsquo;t have a common cipher
suite for key exchange, and can&rsquo;t establish a connection</li><li>When it can&rsquo;t establish a connection with the server, it sends a FIN to the
client (<code>EOF</code>)</li><li>It proceeds to whitelist the client-IP, server-IP, server-port tuple for a
little more than one hour <sup>[<a href=#timeout>timeout</a>]</sup>. It does not attempt to proxy during that time</li><li>It will attempt to proxy new client connections from different IP addresses
during that time</li></ul><p>Our final resolution to this issue was a workaround wherein each test suite that runs <code>cf ssh</code>, we &ldquo;prime the pump&rdquo; by running a <code>cf ssh</code> command, which we expect to fail, before running the test suite.</p><h2 id=footnotes>Footnotes<a hidden class=anchor aria-hidden=true href=#footnotes>#</a></h2><p><a id=timeout><sup>[timeout]</sup></a>
The exact timeout is a little more than an hour, somewhere between 3720 and 3840
seconds.</p><p>We wrote a
<a href=https://github.com/cunnie/bin/blob/c51fceac1a1af6361b4099957960958729e95046/pan_timeout.sh>script</a>
to more precisely determine the timeout. As can be seen from the output below
(edited for clarity), there was no proxy attempt at 3720 seconds (<code>Permission denied...</code>), but there was at 3840 seconds (<code>Connection closed...</code>)</p><pre tabindex=0><code>Permission denied (password).
Timeout: 3720
Connection closed by 10.195.84.17 port 2222
Timeout: 3840
</code></pre><h2 id=corrections--updates>Corrections & Updates<a hidden class=anchor aria-hidden=true href=#corrections--updates>#</a></h2><p><em>2019-01-02</em></p><p>Include the amount of time that the PAN firewall waits after an unsuccessful
proxy attempt before triggering the next attempt.</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://blog.nono.io/post/totp/><span class=title>« Prev</span><br><span>Transferring Time-based One-time Passwords to a New Smartphone</span></a>
<a class=next href=https://blog.nono.io/post/upgrade_2.2-2.3_on_nsx-t/><span class=title>Next »</span><br><span>Safely Upgrading PAS 2.2 with NSX-T Load Balancers</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Troubleshooting Obscure OpenSSH Failures on twitter" href="https://twitter.com/intent/tweet/?text=Troubleshooting%20Obscure%20OpenSSH%20Failures&url=https%3a%2f%2fblog.nono.io%2fpost%2fssh_handshake_failed%2f&hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Troubleshooting Obscure OpenSSH Failures on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.nono.io%2fpost%2fssh_handshake_failed%2f&title=Troubleshooting%20Obscure%20OpenSSH%20Failures&summary=Troubleshooting%20Obscure%20OpenSSH%20Failures&source=https%3a%2f%2fblog.nono.io%2fpost%2fssh_handshake_failed%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Troubleshooting Obscure OpenSSH Failures on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblog.nono.io%2fpost%2fssh_handshake_failed%2f&title=Troubleshooting%20Obscure%20OpenSSH%20Failures"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Troubleshooting Obscure OpenSSH Failures on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.nono.io%2fpost%2fssh_handshake_failed%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Troubleshooting Obscure OpenSSH Failures on whatsapp" href="https://api.whatsapp.com/send?text=Troubleshooting%20Obscure%20OpenSSH%20Failures%20-%20https%3a%2f%2fblog.nono.io%2fpost%2fssh_handshake_failed%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Troubleshooting Obscure OpenSSH Failures on telegram" href="https://telegram.me/share/url?text=Troubleshooting%20Obscure%20OpenSSH%20Failures&url=https%3a%2f%2fblog.nono.io%2fpost%2fssh_handshake_failed%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://blog.nono.io/>Brian Cunnie's Technical Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>