<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Debugging the vSphere API via the BOSH vSphere CPI from Your Workstation | Brian Cunnie's Technical Blog</title>
<meta name=keywords content><meta name=description content="This Blog Post Is Not For You This blog post is directed towards people who are working with the BOSH vSphere CPI (Cloud Provider Interface), which is probably not you. There are more interesting things to read. If you want suggestions, try Ulysses by Sir Alfred Lord Tennyson, a poem about an aged hero seeking to recapture his adventures of youth.
Challenge: Extending the Size of the Root Disk I&rsquo;d like to extend the size of the root partition, but it&rsquo;s a challenge: if I don&rsquo;t make exactly the correct vSphere API calls, my changes will fail, and the feedback loop is slow (hot-patching a BOSH Director and then running a deploy takes at least 5 minutes each attempt)."><meta name=author content="Brian Cunnie"><link rel=canonical href=https://blog.nono.io/post/debugging_vsphere_cpi_api/><link crossorigin=anonymous href=/assets/css/stylesheet.e087fd1dc76e73a35ae6d7028ddc1ba41e0131e7f9b3a6e2d019a208e6d6c4b5.css integrity="sha256-4If9Hcduc6Na5tcCjdwbpB4BMef5s6bi0BmiCObWxLU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://blog.nono.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.nono.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.nono.io/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.nono.io/apple-touch-icon.png><link rel=mask-icon href=https://blog.nono.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-0NJ11E527T"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-0NJ11E527T",{anonymize_ip:!1})}</script><meta property="og:title" content="Debugging the vSphere API via the BOSH vSphere CPI from Your Workstation"><meta property="og:description" content="This Blog Post Is Not For You This blog post is directed towards people who are working with the BOSH vSphere CPI (Cloud Provider Interface), which is probably not you. There are more interesting things to read. If you want suggestions, try Ulysses by Sir Alfred Lord Tennyson, a poem about an aged hero seeking to recapture his adventures of youth.
Challenge: Extending the Size of the Root Disk I&rsquo;d like to extend the size of the root partition, but it&rsquo;s a challenge: if I don&rsquo;t make exactly the correct vSphere API calls, my changes will fail, and the feedback loop is slow (hot-patching a BOSH Director and then running a deploy takes at least 5 minutes each attempt)."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.nono.io/post/debugging_vsphere_cpi_api/"><meta property="og:image" content="https://nono.io/images/brian_cunnie_profile.jpg"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-01-01T14:51:43-08:00"><meta property="article:modified_time" content="2024-01-01T14:51:43-08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://nono.io/images/brian_cunnie_profile.jpg"><meta name=twitter:title content="Debugging the vSphere API via the BOSH vSphere CPI from Your Workstation"><meta name=twitter:description content="This Blog Post Is Not For You This blog post is directed towards people who are working with the BOSH vSphere CPI (Cloud Provider Interface), which is probably not you. There are more interesting things to read. If you want suggestions, try Ulysses by Sir Alfred Lord Tennyson, a poem about an aged hero seeking to recapture his adventures of youth.
Challenge: Extending the Size of the Root Disk I&rsquo;d like to extend the size of the root partition, but it&rsquo;s a challenge: if I don&rsquo;t make exactly the correct vSphere API calls, my changes will fail, and the feedback loop is slow (hot-patching a BOSH Director and then running a deploy takes at least 5 minutes each attempt)."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.nono.io/post/"},{"@type":"ListItem","position":2,"name":"Debugging the vSphere API via the BOSH vSphere CPI from Your Workstation","item":"https://blog.nono.io/post/debugging_vsphere_cpi_api/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Debugging the vSphere API via the BOSH vSphere CPI from Your Workstation","name":"Debugging the vSphere API via the BOSH vSphere CPI from Your Workstation","description":"This Blog Post Is Not For You This blog post is directed towards people who are working with the BOSH vSphere CPI (Cloud Provider Interface), which is probably not you. There are more interesting things to read. If you want suggestions, try Ulysses by Sir Alfred Lord Tennyson, a poem about an aged hero seeking to recapture his adventures of youth.\nChallenge: Extending the Size of the Root Disk I\u0026rsquo;d like to extend the size of the root partition, but it\u0026rsquo;s a challenge: if I don\u0026rsquo;t make exactly the correct vSphere API calls, my changes will fail, and the feedback loop is slow (hot-patching a BOSH Director and then running a deploy takes at least 5 minutes each attempt).","keywords":[],"articleBody":"This Blog Post Is Not For You This blog post is directed towards people who are working with the BOSH vSphere CPI (Cloud Provider Interface), which is probably not you. There are more interesting things to read. If you want suggestions, try Ulysses by Sir Alfred Lord Tennyson, a poem about an aged hero seeking to recapture his adventures of youth.\nChallenge: Extending the Size of the Root Disk I’d like to extend the size of the root partition, but it’s a challenge: if I don’t make exactly the correct vSphere API calls, my changes will fail, and the feedback loop is slow (hot-patching a BOSH Director and then running a deploy takes at least 5 minutes each attempt).\nWhat I really want is a REPL (Read–eval–print loop) so I can test changes quickly. I want pry-byebug.\nHow the CPI Works The CPI entry is a shell script, /var/vcap/jobs/vsphere_cpi/bin/cpi, which is a wrapper around a Ruby executable, /var/vcap/packages/vsphere_cpi/bin/vsphere_cpi\nThe first argument passed to the CPI is a pathname, /var/vcap/jobs/vsphere_cpi/config/cpi.json. These are its contents (at least on my BOSH Director):\n{ \"cloud\": { \"plugin\": \"vsphere\", \"properties\": { \"vcenters\": [ { \"host\": \"vcenter-80.nono.io\", \"user\": \"administrator@vsphere.local\", \"password\": \"some-crazy-password\", \"datacenters\": [ { \"name\": \"dc\", \"vm_folder\": \"bosh-vsphere-vms\", \"template_folder\": \"bosh-vsphere-templates\", \"disk_path\": \"bosh-vsphere-disks\", \"allow_mixed_datastores\": true, \"clusters\": [ { \"cl\": { \"resource_pool\": \"BOSH\" } } ], \"datastore_pattern\": \"NAS-0\", \"persistent_datastore_pattern\": \"NAS-0\" } ], \"default_disk_type\": \"preallocated\", \"enable_auto_anti_affinity_drs_rules\": false, \"memory_reservation_locked_to_max\": false, \"upgrade_hw_version\": false, \"enable_human_readable_name\": true, \"http_logging\": false, \"connection_options\": { \"ca_cert\": null } } ], \"agent\": { \"ntp\": [ \"0.pool.ntp.org\", \"1.pool.ntp.org\" ], \"mbus\": \"nats://73.189.219.4:4222\" } } } } But wait, there’s more: the BOSH Director passes in, via STDIN, the command that it’d like the CPI to perform (e.g. Create a VM, delete a disk, etc.). This is also in JSON.\nHere’s a truncated sample of a create_vm call which, I’ve saved to a file, stdin.json:\n{ \"method\": \"create_vm\", \"arguments\": [ \"882a8a0c-5df4-4e4b-bbe0-292ff1b63c01\", \"sc-fb254d39-49a8-44b9-baa7-a36537a7a4a0\", { \"datacenters\": [ { \"clusters\": [ { \"cl\": { \"resource_pool\": \"BOSH\" } } ], \"name\": \"dc\" } ], \"cpu\": 2, \"disk\": 10240, \"ram\": 2048, \"vmx_options\": { \"disk.enableUUID\": \"1\" } }, A reasonable question to ask is, “Brian, how did you get the create_vm JSON?” I’m glad you asked. I added the following lines of Ruby to /var/vcap/packages/vsphere_cpi/bin/vsphere_cpi:\nFile.open(\"/tmp/#{Process.pid}.json\", 'w') do |file| file.puts cpi_rpc_api_request_raw end Then I ran a deploy which created a VM: bosh -d dummy deploy dummy.yml.\nThen I checked the /tmp directory on the Director for JSON files until I found the one I wanted. I saved the file as stdin.json.\nSetting the Breakpoint Now we’re ready to start debugging. Let’s edit src/vsphere_cpi/lib/cloud/vsphere/vm_creator.rb and insert the following where we want to dynamically test things:\nrequire 'pry-byebug' binding.pry Now let’s run the CPI from our workstation, passing the two JSON files as arguments:\ncd ~/workspace/bosh-vsphere-cpi-release/src/vsphere_cpi/ bin/vsphere_cpi cpi.json stdin.json The previous command will create the VM while printing a slew of log messages to STDERR, and then will drop you into the pry-byebug REPL. Let’s do some quick debugging:\ndevice_specification = Resources::VM.create_edit_device_spec(created_vm.system_disk) # Let's see what methods this newly-created object has: device_specification.methods.sort - 1.methods # Hit ^D when you've finished troubleshooting to continue execution Clean-up: Delete the Created VM You’ll need to delete anything created by your testing because we’re operating outside the BOSH Director. In our example, we’ve been testing the create_vm method, so we’ll need to delete the VM (using the vCenter web UI or govc). To find the VM to delete, examine the JSON emitted by the CPI (it should be the last or second-to-last line of output); it’ll show the ID of any created artifacts. In the example below, the created VM’s ID is jammy_dummy_364cf7e0c4fc:\n{ \"result\": [ \"jammy_dummy_364cf7e0c4fc\", { \"vsphere-guest\": { \"type\": \"manual\", \"ip\": \"10.9.2.37\", \"netmask\": \"255.255.254.0\", \"cloud_properties\": { \"name\": \"guest\" }, \"default\": [ \"dns\", \"gateway\" ], \"dns\": [ \"10.9.2.1\", \"8.8.8.8\" ], \"gateway\": \"10.9.2.1\" } } ], \"error\": null, \"log\": \"\" } References:\ncpi.json stdin.json ","wordCount":"641","inLanguage":"en","datePublished":"2024-01-01T14:51:43-08:00","dateModified":"2024-01-01T14:51:43-08:00","author":{"@type":"Person","name":"Brian Cunnie"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.nono.io/post/debugging_vsphere_cpi_api/"},"publisher":{"@type":"Organization","name":"Brian Cunnie's Technical Blog","logo":{"@type":"ImageObject","url":"https://blog.nono.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.nono.io/ accesskey=h title="Brian Cunnie's Technical Blog (Alt + H)">Brian Cunnie's Technical Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.nono.io/>Home</a>&nbsp;»&nbsp;<a href=https://blog.nono.io/post/>Posts</a></div><h1 class="post-title entry-hint-parent">Debugging the vSphere API via the BOSH vSphere CPI from Your Workstation</h1><div class=post-meta><span title='2024-01-01 14:51:43 -0800 -0800'>January 1, 2024</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;Brian Cunnie&nbsp;|&nbsp;<a href=https://github.com/cunnie/cunnie.github.io/tree/master/content/post/debugging_vsphere_cpi_api.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><h3 id=this-blog-post-is-not-for-you>This Blog Post Is Not For You<a hidden class=anchor aria-hidden=true href=#this-blog-post-is-not-for-you>#</a></h3><p>This blog post is directed towards people who are working with the BOSH vSphere
CPI (Cloud Provider Interface), which is probably not you. There are more
interesting things to read. If you want suggestions, try
<em><a href=https://www.poetryfoundation.org/poems/45392/ulysses>Ulysses</a></em> by Sir Alfred
Lord Tennyson, a poem about an aged hero seeking to recapture his adventures of
youth.</p><h3 id=challenge-extending-the-size-of-the-root-disk>Challenge: Extending the Size of the Root Disk<a hidden class=anchor aria-hidden=true href=#challenge-extending-the-size-of-the-root-disk>#</a></h3><p>I&rsquo;d like to extend the size of the root partition, but it&rsquo;s a challenge: if I
don&rsquo;t make exactly the correct vSphere API calls, my changes will fail, and the
feedback loop is slow (hot-patching a BOSH Director and then running a deploy
takes at least 5 minutes each attempt).</p><p>What I really want is a REPL (<a href=https://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop>Read–eval–print
loop</a>) so I
can test changes quickly. I want
<a href=https://www.rubydoc.info/gems/pry-byebug/3.10.1><code>pry-byebug</code></a>.</p><h3 id=how-the-cpi-works>How the CPI Works<a hidden class=anchor aria-hidden=true href=#how-the-cpi-works>#</a></h3><p>The CPI entry is a shell script, <code>/var/vcap/jobs/vsphere_cpi/bin/cpi</code>, which is
a wrapper around a Ruby executable,
<code>/var/vcap/packages/vsphere_cpi/bin/vsphere_cpi</code></p><p>The first argument passed to the CPI is a pathname,
<code>/var/vcap/jobs/vsphere_cpi/config/cpi.json</code>. These are its contents (at least
on my BOSH Director):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;cloud&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;plugin&#34;</span>: <span style=color:#e6db74>&#34;vsphere&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;properties&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;vcenters&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;host&#34;</span>: <span style=color:#e6db74>&#34;vcenter-80.nono.io&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;user&#34;</span>: <span style=color:#e6db74>&#34;administrator@vsphere.local&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;password&#34;</span>: <span style=color:#e6db74>&#34;some-crazy-password&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;datacenters&#34;</span>: [
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;dc&#34;</span>,
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;vm_folder&#34;</span>: <span style=color:#e6db74>&#34;bosh-vsphere-vms&#34;</span>,
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;template_folder&#34;</span>: <span style=color:#e6db74>&#34;bosh-vsphere-templates&#34;</span>,
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;disk_path&#34;</span>: <span style=color:#e6db74>&#34;bosh-vsphere-disks&#34;</span>,
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;allow_mixed_datastores&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;clusters&#34;</span>: [
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                  <span style=color:#f92672>&#34;cl&#34;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;resource_pool&#34;</span>: <span style=color:#e6db74>&#34;BOSH&#34;</span>
</span></span><span style=display:flex><span>                  }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>              ],
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;datastore_pattern&#34;</span>: <span style=color:#e6db74>&#34;NAS-0&#34;</span>,
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;persistent_datastore_pattern&#34;</span>: <span style=color:#e6db74>&#34;NAS-0&#34;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          ],
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;default_disk_type&#34;</span>: <span style=color:#e6db74>&#34;preallocated&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;enable_auto_anti_affinity_drs_rules&#34;</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;memory_reservation_locked_to_max&#34;</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;upgrade_hw_version&#34;</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;enable_human_readable_name&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;http_logging&#34;</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;connection_options&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;ca_cert&#34;</span>: <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ],
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;agent&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;ntp&#34;</span>: [
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;0.pool.ntp.org&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;1.pool.ntp.org&#34;</span>
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;mbus&#34;</span>: <span style=color:#e6db74>&#34;nats://73.189.219.4:4222&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>But wait, there&rsquo;s more: the BOSH Director passes in, <em>via STDIN</em>, the command
that it&rsquo;d like the CPI to perform (e.g. Create a VM, delete a disk, etc.). This
is also in JSON.</p><p>Here&rsquo;s a truncated sample of a <code>create_vm</code> call which, I&rsquo;ve saved to a file,
<code>stdin.json</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;method&#34;</span>: <span style=color:#e6db74>&#34;create_vm&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;arguments&#34;</span>: [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;882a8a0c-5df4-4e4b-bbe0-292ff1b63c01&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;sc-fb254d39-49a8-44b9-baa7-a36537a7a4a0&#34;</span>,
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;datacenters&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;clusters&#34;</span>: [
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;cl&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;resource_pool&#34;</span>: <span style=color:#e6db74>&#34;BOSH&#34;</span>
</span></span><span style=display:flex><span>              }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          ],
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;dc&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ],
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;cpu&#34;</span>: <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;disk&#34;</span>: <span style=color:#ae81ff>10240</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;ram&#34;</span>: <span style=color:#ae81ff>2048</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;vmx_options&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;disk.enableUUID&#34;</span>: <span style=color:#e6db74>&#34;1&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    },
</span></span></code></pre></div><p>A reasonable question to ask is, &ldquo;Brian, how did you get the <code>create_vm</code> JSON?&rdquo;
I&rsquo;m glad you asked. I added the following lines of Ruby to
<a href=https://github.com/cloudfoundry/bosh-vsphere-cpi-release/blob/b95bac3d8cf50e1332663684336c30ccd1a492a7/src/vsphere_cpi/bin/vsphere_cpi#L38><code>/var/vcap/packages/vsphere_cpi/bin/vsphere_cpi</code></a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Ruby data-lang=Ruby><span style=display:flex><span><span style=color:#66d9ef>File</span><span style=color:#f92672>.</span>open(<span style=color:#e6db74>&#34;/tmp/</span><span style=color:#e6db74>#{</span><span style=color:#66d9ef>Process</span><span style=color:#f92672>.</span>pid<span style=color:#e6db74>}</span><span style=color:#e6db74>.json&#34;</span>, <span style=color:#e6db74>&#39;w&#39;</span>) <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>file<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>  file<span style=color:#f92672>.</span>puts cpi_rpc_api_request_raw
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Then I ran a deploy which created a VM: <code>bosh -d dummy deploy dummy.yml</code>.</p><p>Then I checked the <code>/tmp</code> directory on the Director for JSON files until I found
the one I wanted. I saved the file as <code>stdin.json</code>.</p><h3 id=setting-the-breakpoint>Setting the Breakpoint<a hidden class=anchor aria-hidden=true href=#setting-the-breakpoint>#</a></h3><p>Now we&rsquo;re ready to start debugging. Let&rsquo;s edit
<code>src/vsphere_cpi/lib/cloud/vsphere/vm_creator.rb</code> and insert the following
where we want to dynamically test things:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>require <span style=color:#e6db74>&#39;pry-byebug&#39;</span>
</span></span><span style=display:flex><span>binding<span style=color:#f92672>.</span>pry
</span></span></code></pre></div><p>Now let&rsquo;s run the CPI from our workstation, passing the two JSON files as
arguments:</p><pre tabindex=0><code>cd ~/workspace/bosh-vsphere-cpi-release/src/vsphere_cpi/
bin/vsphere_cpi cpi.json stdin.json
</code></pre><p>The previous command will create the VM while printing a slew of log messages
to STDERR, and then will drop you into the pry-byebug REPL. Let&rsquo;s do some quick
debugging:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>device_specification <span style=color:#f92672>=</span> <span style=color:#66d9ef>Resources</span><span style=color:#f92672>::</span><span style=color:#66d9ef>VM</span><span style=color:#f92672>.</span>create_edit_device_spec(created_vm<span style=color:#f92672>.</span>system_disk)
</span></span><span style=display:flex><span> <span style=color:#75715e># Let&#39;s see what methods this newly-created object has:</span>
</span></span><span style=display:flex><span>device_specification<span style=color:#f92672>.</span>methods<span style=color:#f92672>.</span>sort <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>.</span>methods
</span></span><span style=display:flex><span> <span style=color:#75715e># Hit ^D when you&#39;ve finished troubleshooting to continue execution</span>
</span></span></code></pre></div><h3 id=clean-up-delete-the-created-vm>Clean-up: Delete the Created VM<a hidden class=anchor aria-hidden=true href=#clean-up-delete-the-created-vm>#</a></h3><p>You&rsquo;ll need to delete anything created by your testing because we&rsquo;re operating
<em>outside</em> the BOSH Director. In our example, we&rsquo;ve been testing the <code>create_vm</code>
method, so we&rsquo;ll need to delete the VM (using the vCenter web UI or <code>govc</code>). To
find the VM to delete, examine the JSON emitted by the CPI (it should be the
last or second-to-last line of output); it&rsquo;ll show the ID of any created
artifacts. In the example below, the created VM&rsquo;s ID is
<code>jammy_dummy_364cf7e0c4fc</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;result&#34;</span>: [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;jammy_dummy_364cf7e0c4fc&#34;</span>,
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;vsphere-guest&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;manual&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;ip&#34;</span>: <span style=color:#e6db74>&#34;10.9.2.37&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;netmask&#34;</span>: <span style=color:#e6db74>&#34;255.255.254.0&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;cloud_properties&#34;</span>: {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;guest&#34;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;default&#34;</span>: [
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;dns&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;gateway&#34;</span>
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;dns&#34;</span>: [
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;10.9.2.1&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;8.8.8.8&#34;</span>
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;gateway&#34;</span>: <span style=color:#e6db74>&#34;10.9.2.1&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;error&#34;</span>: <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;log&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>References:</p><ul><li><a href=/assets/cpi.json><code>cpi.json</code></a></li><li><a href=/assets/stdin.json><code>stdin.json</code></a></li></ul></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=next href=https://blog.nono.io/post/nsx_tls/><span class=title>Next »</span><br><span>How to Install a TLS Certificate on NSX 4.1</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Debugging the vSphere API via the BOSH vSphere CPI from Your Workstation on x" href="https://x.com/intent/tweet/?text=Debugging%20the%20vSphere%20API%20via%20the%20BOSH%20vSphere%20CPI%20from%20Your%20Workstation&amp;url=https%3a%2f%2fblog.nono.io%2fpost%2fdebugging_vsphere_cpi_api%2f&amp;hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Debugging the vSphere API via the BOSH vSphere CPI from Your Workstation on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fblog.nono.io%2fpost%2fdebugging_vsphere_cpi_api%2f&amp;title=Debugging%20the%20vSphere%20API%20via%20the%20BOSH%20vSphere%20CPI%20from%20Your%20Workstation&amp;summary=Debugging%20the%20vSphere%20API%20via%20the%20BOSH%20vSphere%20CPI%20from%20Your%20Workstation&amp;source=https%3a%2f%2fblog.nono.io%2fpost%2fdebugging_vsphere_cpi_api%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Debugging the vSphere API via the BOSH vSphere CPI from Your Workstation on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblog.nono.io%2fpost%2fdebugging_vsphere_cpi_api%2f&title=Debugging%20the%20vSphere%20API%20via%20the%20BOSH%20vSphere%20CPI%20from%20Your%20Workstation"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Debugging the vSphere API via the BOSH vSphere CPI from Your Workstation on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.nono.io%2fpost%2fdebugging_vsphere_cpi_api%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Debugging the vSphere API via the BOSH vSphere CPI from Your Workstation on whatsapp" href="https://api.whatsapp.com/send?text=Debugging%20the%20vSphere%20API%20via%20the%20BOSH%20vSphere%20CPI%20from%20Your%20Workstation%20-%20https%3a%2f%2fblog.nono.io%2fpost%2fdebugging_vsphere_cpi_api%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Debugging the vSphere API via the BOSH vSphere CPI from Your Workstation on telegram" href="https://telegram.me/share/url?text=Debugging%20the%20vSphere%20API%20via%20the%20BOSH%20vSphere%20CPI%20from%20Your%20Workstation&amp;url=https%3a%2f%2fblog.nono.io%2fpost%2fdebugging_vsphere_cpi_api%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Debugging the vSphere API via the BOSH vSphere CPI from Your Workstation on ycombinator" href="https://news.ycombinator.com/submitlink?t=Debugging%20the%20vSphere%20API%20via%20the%20BOSH%20vSphere%20CPI%20from%20Your%20Workstation&u=https%3a%2f%2fblog.nono.io%2fpost%2fdebugging_vsphere_cpi_api%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://blog.nono.io/>Brian Cunnie's Technical Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>