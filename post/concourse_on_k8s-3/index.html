<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Concourse CI on Kubernetes (GKE), Part 3: TLS | Brian Cunnie's Technical Blog</title><meta name=keywords content><meta name=description content="
     


In our previous blog post, we configured ingress to our Kubernetes cluster but
were disappointed to discover that the TLS certificates were self-signed. In
this post we&rsquo;ll remedy that by installing cert-manager, the Cloud native
certificate management tool.
Disclaimer: most of this blog post was lifted whole cloth from the
most-excellent cert-manager documentation.
We merely condensed it & made it more opinionated.
Installation
Let&rsquo;s add the Jetstack Helm Repository:"><meta name=author content="Brian Cunnie"><link rel=canonical href=https://blog.nono.io/post/concourse_on_k8s-3/><link crossorigin=anonymous href=/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css integrity="sha256-1vzSCk+4bvpN+sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.nono.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.nono.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.nono.io/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.nono.io/apple-touch-icon.png><link rel=mask-icon href=https://blog.nono.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://blog.nono.io/post/concourse_on_k8s-3/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-0NJ11E527T"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-0NJ11E527T")}</script><meta property="og:url" content="https://blog.nono.io/post/concourse_on_k8s-3/"><meta property="og:site_name" content="Brian Cunnie's Technical Blog"><meta property="og:title" content="Concourse CI on Kubernetes (GKE), Part 3: TLS"><meta property="og:description" content=" In our previous blog post, we configured ingress to our Kubernetes cluster but were disappointed to discover that the TLS certificates were self-signed. In this post we’ll remedy that by installing cert-manager, the Cloud native certificate management tool.
Disclaimer: most of this blog post was lifted whole cloth from the most-excellent cert-manager documentation. We merely condensed it & made it more opinionated.
Installation Let’s add the Jetstack Helm Repository:"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-08-11T16:55:31-07:00"><meta property="article:modified_time" content="2021-08-11T16:55:31-07:00"><meta property="og:image" content="https://letsencrypt.org/images/letsencrypt-logo-horizontal.svg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://letsencrypt.org/images/letsencrypt-logo-horizontal.svg"><meta name=twitter:title content="Concourse CI on Kubernetes (GKE), Part 3: TLS"><meta name=twitter:description content="
     


In our previous blog post, we configured ingress to our Kubernetes cluster but
were disappointed to discover that the TLS certificates were self-signed. In
this post we&rsquo;ll remedy that by installing cert-manager, the Cloud native
certificate management tool.
Disclaimer: most of this blog post was lifted whole cloth from the
most-excellent cert-manager documentation.
We merely condensed it & made it more opinionated.
Installation
Let&rsquo;s add the Jetstack Helm Repository:"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.nono.io/post/"},{"@type":"ListItem","position":2,"name":"Concourse CI on Kubernetes (GKE), Part 3: TLS","item":"https://blog.nono.io/post/concourse_on_k8s-3/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Concourse CI on Kubernetes (GKE), Part 3: TLS","name":"Concourse CI on Kubernetes (GKE), Part 3: TLS","description":" In our previous blog post, we configured ingress to our Kubernetes cluster but were disappointed to discover that the TLS certificates were self-signed. In this post we\u0026rsquo;ll remedy that by installing cert-manager, the Cloud native certificate management tool.\nDisclaimer: most of this blog post was lifted whole cloth from the most-excellent cert-manager documentation. We merely condensed it \u0026amp; made it more opinionated.\nInstallation Let\u0026rsquo;s add the Jetstack Helm Repository:\n","keywords":[],"articleBody":" In our previous blog post, we configured ingress to our Kubernetes cluster but were disappointed to discover that the TLS certificates were self-signed. In this post we’ll remedy that by installing cert-manager, the Cloud native certificate management tool.\nDisclaimer: most of this blog post was lifted whole cloth from the most-excellent cert-manager documentation. We merely condensed it \u0026 made it more opinionated.\nInstallation Let’s add the Jetstack Helm Repository:\nhelm repo add jetstack https://charts.jetstack.io helm repo update Let’s install cert-manager:\nhelm install \\ cert-manager jetstack/cert-manager \\ --namespace cert-manager \\ --create-namespace \\ --version v1.6.1 \\ --set installCRDs=true Verifying Installation Do we see all three pods?\nkubectl get pods --namespace cert-manager Now let’s create an issuer to test the webhook:\ncat \u003c test-resources.yaml apiVersion: v1 kind: Namespace metadata: name: cert-manager-test --- apiVersion: cert-manager.io/v1 kind: Issuer metadata: name: test-selfsigned namespace: cert-manager-test spec: selfSigned: {} --- apiVersion: cert-manager.io/v1 kind: Certificate metadata: name: selfsigned-cert namespace: cert-manager-test spec: dnsNames: - example.com secretName: selfsigned-cert-tls issuerRef: name: test-selfsigned EOF And now let’s apply those resources:\nkubectl apply -f test-resources.yaml sleep 10 kubectl describe certificate -n cert-manager-test | grep \"has been successfully\" kubectl delete -f test-resources.yaml 4. Deploy an Example Service Let’s install the sample services to test the controller:\nkubectl apply -f https://netlify.cert-manager.io/docs/tutorials/acme/example/deployment.yaml kubectl apply -f https://netlify.cert-manager.io/docs/tutorials/acme/example/service.yaml Let’s download and edit the Ingress (we’ve already configured gke.nono.io to point to the GCP/GKE load balancer at 34.135.26.144). Replace gke.nono.io with the DNS record of your load balancer set up in the previous blog post:\ncurl -o ingress-kuard.yml -L https://netlify.cert-manager.io/docs/tutorials/acme/example/ingress.yaml sed -i '' \"s/example.example.com/gke.nono.io/g\" ingress-kuard.yml kubectl apply -f ingress-kuard.yml Let’s use curl to check the GKE load balancer. Replace gke.nono.io with the DNS record of your load balancer set up in the previous blog post:\ncurl -kivL -H 'Host: gke.nono.io' https://gke.nono.io You should see output similar to the following (note that the cert is still self-signed):\n... * Server certificate: * subject: O=Acme Co; CN=Kubernetes Ingress Controller Fake Certificate 6. Configure Let’s Encrypt Issuer Let’s deploy the staging \u0026 production issuers. Replace brian.cunnie@gmail.com with your email address:\nkubectl apply -f \u003c( curl -o- https://cert-manager.io/docs/tutorials/acme/example/staging-issuer.yaml | sed 's/user@example.com/brian.cunnie@gmail.com/') kubectl apply -f \u003c( curl -o- https://cert-manager.io/docs/tutorials/acme/example/production-issuer.yaml | sed 's/user@example.com/brian.cunnie@gmail.com/') # check to make sure they were deployed: kubectl describe issuer letsencrypt-staging kubectl describe issuer letsencrypt-prod 7. Step 7 - Deploy a TLS Ingress Resource Let’s deploy the ingress resource using annotations to obtain the certificate. Replace gke.nono.io with the DNS record of your load balancer set up in the previous blog post:\nkubectl apply -f \u003c( curl -o- https://cert-manager.io/docs/tutorials/acme/example/ingress-tls.yaml | sed 's/example.example.com/gke.nono.io/') kubectl get certificate # takes ~30s to become ready (\"READY\" == \"True\") kubectl describe certificate quickstart-example-tls kubectl describe secret quickstart-example-tls Let’s use curl again to check the GKE load balancer’s certificate. Replace gke.nono.io with the DNS record of your load balancer set up in the previous blog post:\ncurl -kivL -H 'Host: gke.nono.io' https://gke.nono.io You should see output similar to the following:\n... * Server certificate: * subject: CN=gke.nono.io * start date: Sep 1 22:02:55 2021 GMT * expire date: Nov 30 22:02:54 2021 GMT * issuer: C=US; O=(STAGING) Let's Encrypt; CN=(STAGING) Artificial Apricot R3 Great! We have the staging cert, but that’s not quite good enough—we want a real certificate. Let’s upgrade to the production certificate. As usual, Replace gke.nono.io with the DNS record of your load balancer set up in the previous blog post:\nkubectl apply -f \u003c( curl -o- https://cert-manager.io/docs/tutorials/acme/example/ingress-tls-final.yaml | sed 's/example.example.com/gke.nono.io/') kubectl delete secret quickstart-example-tls # triggers the process to get a new certificate kubectl get certificate # takes ~30s to become ready (\"READY\" == \"True\") kubectl describe certificate quickstart-example-tls kubectl describe secret quickstart-example-tls Let’s use curl one more time to check the GKE load balancer’s certificate. Replace gke.nono.io with the DNS record of your load balancer set up in the previous blog post:\ncurl -kivL -H 'Host: gke.nono.io' https://gke.nono.io You should see output similar to the following:\n... * Server certificate: * subject: CN=gke.nono.io * start date: Sep 1 22:11:36 2021 GMT * expire date: Nov 30 22:11:35 2021 GMT * issuer: C=US; O=Let's Encrypt; CN=R3 * SSL certificate verify ok. And now browse (replacing gke.nono.io with the DNS record of your load balancer): https://gke.nono.io/. Yes, we get an HTTP 503 status, but our certificate is valid!\nStay Tuned! Stay tuned for our next installment, where we install Concourse CI on GKE.\nReferences cert-manager documentation: https://cert-manager.io/docs/ Updates/Errata 2022-01-08 Bumped the cert-manager version 1.6.0 → 1.6.1; fixed scheme (was http; now is https)\n2021-11-13 Bumped the cert-manager version 1.5.0 → 1.6.0\n","wordCount":"747","inLanguage":"en","image":"https://letsencrypt.org/images/letsencrypt-logo-horizontal.svg","datePublished":"2021-08-11T16:55:31-07:00","dateModified":"2021-08-11T16:55:31-07:00","author":{"@type":"Person","name":"Brian Cunnie"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.nono.io/post/concourse_on_k8s-3/"},"publisher":{"@type":"Organization","name":"Brian Cunnie's Technical Blog","logo":{"@type":"ImageObject","url":"https://blog.nono.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.nono.io/ accesskey=h title="Brian Cunnie's Technical Blog (Alt + H)">Brian Cunnie's Technical Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.nono.io/>Home</a>&nbsp;»&nbsp;<a href=https://blog.nono.io/post/>Posts</a></div><h1 class="post-title entry-hint-parent">Concourse CI on Kubernetes (GKE), Part 3: TLS</h1><div class=post-meta><span title='2021-08-11 16:55:31 -0700 -0700'>August 11, 2021</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;Brian Cunnie&nbsp;|&nbsp;<a href=https://github.com/cunnie/cunnie.github.io/tree/master/content/post/concourse_on_k8s-3.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><figure><img loading=lazy src=https://letsencrypt.org/images/letsencrypt-logo-horizontal.svg alt="Let's Encrypt logo"></figure><p>In our previous blog post, we configured ingress to our Kubernetes cluster but
were disappointed to discover that the TLS certificates were self-signed. In
this post we&rsquo;ll remedy that by installing cert-manager, the Cloud native
certificate management tool.</p><p>Disclaimer: most of this blog post was lifted whole cloth from the
most-excellent <a href=https://cert-manager.io/docs/>cert-manager documentation</a>.
We merely condensed it & made it more opinionated.</p><h3 id=installation>Installation<a hidden class=anchor aria-hidden=true href=#installation>#</a></h3><p>Let&rsquo;s add the Jetstack Helm Repository:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm repo add jetstack https://charts.jetstack.io
</span></span><span style=display:flex><span>helm repo update
</span></span></code></pre></div><p>Let&rsquo;s <a href=https://cert-manager.io/docs/installation/helm/#4-install-cert-manager>install cert-manager</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm install <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  cert-manager jetstack/cert-manager <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --namespace cert-manager <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --create-namespace <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --version v1.6.1 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --set installCRDs<span style=color:#f92672>=</span>true
</span></span></code></pre></div><h3 id=verifying-installationhttpscert-manageriodocsinstallationverifymanual-verification><a href=https://cert-manager.io/docs/installation/verify/#manual-verification>Verifying Installation</a><a hidden class=anchor aria-hidden=true href=#verifying-installationhttpscert-manageriodocsinstallationverifymanual-verification>#</a></h3><p>Do we see all three pods?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get pods --namespace cert-manager
</span></span></code></pre></div><p>Now let&rsquo;s create an issuer to test the webhook:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;EOF &gt; test-resources.yaml
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: Namespace
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  name: cert-manager-test
</span></span></span><span style=display:flex><span><span style=color:#e6db74>---
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: cert-manager.io/v1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: Issuer
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  name: test-selfsigned
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  namespace: cert-manager-test
</span></span></span><span style=display:flex><span><span style=color:#e6db74>spec:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  selfSigned: {}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>---
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: cert-manager.io/v1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: Certificate
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  name: selfsigned-cert
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  namespace: cert-manager-test
</span></span></span><span style=display:flex><span><span style=color:#e6db74>spec:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  dnsNames:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - example.com
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  secretName: selfsigned-cert-tls
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  issuerRef:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    name: test-selfsigned
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p>And now let&rsquo;s apply those resources:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f test-resources.yaml
</span></span><span style=display:flex><span>sleep <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>kubectl describe certificate -n cert-manager-test | grep <span style=color:#e6db74>&#34;has been successfully&#34;</span>
</span></span><span style=display:flex><span>kubectl delete -f test-resources.yaml
</span></span></code></pre></div><h4 id=4-deploy-an-example-servicehttpscert-manageriodocstutorialsacmeingressstep-4-deploy-an-example-service>4. <a href=https://cert-manager.io/docs/tutorials/acme/ingress/#step-4-deploy-an-example-service>Deploy an Example Service</a><a hidden class=anchor aria-hidden=true href=#4-deploy-an-example-servicehttpscert-manageriodocstutorialsacmeingressstep-4-deploy-an-example-service>#</a></h4><p>Let&rsquo;s install the sample services to test the controller:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f https://netlify.cert-manager.io/docs/tutorials/acme/example/deployment.yaml
</span></span><span style=display:flex><span>kubectl apply -f https://netlify.cert-manager.io/docs/tutorials/acme/example/service.yaml
</span></span></code></pre></div><p>Let&rsquo;s download and edit the Ingress (we&rsquo;ve already configured <code>gke.nono.io</code> to
point to the GCP/GKE load balancer at 34.135.26.144). <strong>Replace <code>gke.nono.io</code>
with the DNS record of your load balancer</strong> set up in the previous blog post:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -o ingress-kuard.yml -L https://netlify.cert-manager.io/docs/tutorials/acme/example/ingress.yaml
</span></span><span style=display:flex><span>sed -i <span style=color:#e6db74>&#39;&#39;</span> <span style=color:#e6db74>&#34;s/example.example.com/gke.nono.io/g&#34;</span> ingress-kuard.yml
</span></span><span style=display:flex><span>kubectl apply -f ingress-kuard.yml
</span></span></code></pre></div><p>Let&rsquo;s use curl to check the GKE load balancer. <strong>Replace <code>gke.nono.io</code> with the
DNS record of your load balancer</strong> set up in the previous blog post:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -kivL -H <span style=color:#e6db74>&#39;Host: gke.nono.io&#39;</span> https://gke.nono.io
</span></span></code></pre></div><p>You should see output similar to the following (note that the cert is still
self-signed):</p><pre tabindex=0><code>...
* Server certificate:
*  subject: O=Acme Co; CN=Kubernetes Ingress Controller Fake Certificate
</code></pre><h4 id=6-configure-lets-encrypt-issuerhttpscert-manageriodocstutorialsacmeingressstep-6-configure-let-s-encrypt-issuer>6. <a href=https://cert-manager.io/docs/tutorials/acme/ingress/#step-6-configure-let-s-encrypt-issuer>Configure Let’s Encrypt Issuer</a><a hidden class=anchor aria-hidden=true href=#6-configure-lets-encrypt-issuerhttpscert-manageriodocstutorialsacmeingressstep-6-configure-let-s-encrypt-issuer>#</a></h4><p>Let&rsquo;s deploy the staging & production issuers. <strong>Replace
<code>brian.cunnie@gmail.com</code> with your email address</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f &lt;<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>  curl -o- https://cert-manager.io/docs/tutorials/acme/example/staging-issuer.yaml |
</span></span><span style=display:flex><span>  sed <span style=color:#e6db74>&#39;s/user@example.com/brian.cunnie@gmail.com/&#39;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>kubectl apply -f &lt;<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>  curl -o- https://cert-manager.io/docs/tutorials/acme/example/production-issuer.yaml |
</span></span><span style=display:flex><span>  sed <span style=color:#e6db74>&#39;s/user@example.com/brian.cunnie@gmail.com/&#39;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> <span style=color:#75715e># check to make sure they were deployed:</span>
</span></span><span style=display:flex><span>kubectl describe issuer letsencrypt-staging
</span></span><span style=display:flex><span>kubectl describe issuer letsencrypt-prod
</span></span></code></pre></div><h4 id=7-step-7---deploy-a-tls-ingress-resourcehttpscert-manageriodocstutorialsacmeingressstep-7-deploy-a-tls-ingress-resource>7. <a href=https://cert-manager.io/docs/tutorials/acme/ingress/#step-7-deploy-a-tls-ingress-resource>Step 7 - Deploy a TLS Ingress Resource</a><a hidden class=anchor aria-hidden=true href=#7-step-7---deploy-a-tls-ingress-resourcehttpscert-manageriodocstutorialsacmeingressstep-7-deploy-a-tls-ingress-resource>#</a></h4><p>Let&rsquo;s deploy the ingress resource using annotations to obtain the certificate.
<strong>Replace <code>gke.nono.io</code> with the DNS record of your load balancer</strong> set up in
the previous blog post:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f &lt;<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>  curl -o- https://cert-manager.io/docs/tutorials/acme/example/ingress-tls.yaml |
</span></span><span style=display:flex><span>  sed <span style=color:#e6db74>&#39;s/example.example.com/gke.nono.io/&#39;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>kubectl get certificate <span style=color:#75715e># takes ~30s to become ready (&#34;READY&#34; == &#34;True&#34;)</span>
</span></span><span style=display:flex><span>kubectl describe certificate quickstart-example-tls
</span></span><span style=display:flex><span>kubectl describe secret quickstart-example-tls
</span></span></code></pre></div><p>Let&rsquo;s use curl again to check the GKE load balancer&rsquo;s certificate. <strong>Replace
<code>gke.nono.io</code> with the DNS record of your load balancer</strong> set up in the previous
blog post:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -kivL -H <span style=color:#e6db74>&#39;Host: gke.nono.io&#39;</span> https://gke.nono.io
</span></span></code></pre></div><p>You should see output similar to the following:</p><pre tabindex=0><code>...
* Server certificate:
*  subject: CN=gke.nono.io
*  start date: Sep  1 22:02:55 2021 GMT
*  expire date: Nov 30 22:02:54 2021 GMT
*  issuer: C=US; O=(STAGING) Let&#39;s Encrypt; CN=(STAGING) Artificial Apricot R3
</code></pre><p>Great! We have the staging cert, but that&rsquo;s not quite good enough—we want a real
certificate. Let&rsquo;s upgrade to the production certificate. As usual, <strong>Replace
<code>gke.nono.io</code> with the DNS record of your load balancer</strong> set up in the previous
blog post:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f &lt;<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>  curl -o- https://cert-manager.io/docs/tutorials/acme/example/ingress-tls-final.yaml |
</span></span><span style=display:flex><span>  sed <span style=color:#e6db74>&#39;s/example.example.com/gke.nono.io/&#39;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>kubectl delete secret quickstart-example-tls <span style=color:#75715e># triggers the process to get a new certificate</span>
</span></span><span style=display:flex><span>kubectl get certificate <span style=color:#75715e># takes ~30s to become ready (&#34;READY&#34; == &#34;True&#34;)</span>
</span></span><span style=display:flex><span>kubectl describe certificate quickstart-example-tls
</span></span><span style=display:flex><span>kubectl describe secret quickstart-example-tls
</span></span></code></pre></div><p>Let&rsquo;s use curl one more time to check the GKE load balancer&rsquo;s certificate.
<strong>Replace <code>gke.nono.io</code> with the DNS record of your load balancer</strong> set up in
the previous blog post:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -kivL -H <span style=color:#e6db74>&#39;Host: gke.nono.io&#39;</span> https://gke.nono.io
</span></span></code></pre></div><p>You should see output similar to the following:</p><pre tabindex=0><code>...
* Server certificate:
*  subject: CN=gke.nono.io
*  start date: Sep  1 22:11:36 2021 GMT
*  expire date: Nov 30 22:11:35 2021 GMT
*  issuer: C=US; O=Let&#39;s Encrypt; CN=R3
*  SSL certificate verify ok.
</code></pre><p>And now browse (replacing <code>gke.nono.io</code> with the DNS record of your load
balancer): <a href=https://gke.nono.io/>https://gke.nono.io/</a>. Yes, we get an HTTP 503 status, but our
certificate is valid!</p><h4 id=stay-tuned>Stay Tuned!<a hidden class=anchor aria-hidden=true href=#stay-tuned>#</a></h4><p>Stay tuned for our next installment, where we install Concourse CI on GKE.</p><hr><h3 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h3><ul><li>cert-manager documentation: <a href=https://cert-manager.io/docs/>https://cert-manager.io/docs/</a></li></ul><h3 id=updateserrata>Updates/Errata<a hidden class=anchor aria-hidden=true href=#updateserrata>#</a></h3><p><strong>2022-01-08</strong> Bumped the <em>cert-manager</em> version 1.6.0 → 1.6.1; fixed scheme (was <code>http</code>; now is <code>https</code>)</p><p><strong>2021-11-13</strong> Bumped the <em>cert-manager</em> version 1.5.0 → 1.6.0</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://blog.nono.io/post/concourse_on_k8s-4/><span class=title>« Prev</span><br><span>Concourse CI on Kubernetes (GKE), Part 4: Concourse</span>
</a><a class=next href=https://blog.nono.io/post/concourse_on_k8s-2/><span class=title>Next »</span><br><span>Concourse CI on Kubernetes (GKE), Part 2: Ingress</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Concourse CI on Kubernetes (GKE), Part 3: TLS on x" href="https://x.com/intent/tweet/?text=Concourse%20CI%20on%20Kubernetes%20%28GKE%29%2c%20Part%203%3a%20TLS&amp;url=https%3a%2f%2fblog.nono.io%2fpost%2fconcourse_on_k8s-3%2f&amp;hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Concourse CI on Kubernetes (GKE), Part 3: TLS on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fblog.nono.io%2fpost%2fconcourse_on_k8s-3%2f&amp;title=Concourse%20CI%20on%20Kubernetes%20%28GKE%29%2c%20Part%203%3a%20TLS&amp;summary=Concourse%20CI%20on%20Kubernetes%20%28GKE%29%2c%20Part%203%3a%20TLS&amp;source=https%3a%2f%2fblog.nono.io%2fpost%2fconcourse_on_k8s-3%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Concourse CI on Kubernetes (GKE), Part 3: TLS on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblog.nono.io%2fpost%2fconcourse_on_k8s-3%2f&title=Concourse%20CI%20on%20Kubernetes%20%28GKE%29%2c%20Part%203%3a%20TLS"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Concourse CI on Kubernetes (GKE), Part 3: TLS on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.nono.io%2fpost%2fconcourse_on_k8s-3%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Concourse CI on Kubernetes (GKE), Part 3: TLS on whatsapp" href="https://api.whatsapp.com/send?text=Concourse%20CI%20on%20Kubernetes%20%28GKE%29%2c%20Part%203%3a%20TLS%20-%20https%3a%2f%2fblog.nono.io%2fpost%2fconcourse_on_k8s-3%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Concourse CI on Kubernetes (GKE), Part 3: TLS on telegram" href="https://telegram.me/share/url?text=Concourse%20CI%20on%20Kubernetes%20%28GKE%29%2c%20Part%203%3a%20TLS&amp;url=https%3a%2f%2fblog.nono.io%2fpost%2fconcourse_on_k8s-3%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Concourse CI on Kubernetes (GKE), Part 3: TLS on ycombinator" href="https://news.ycombinator.com/submitlink?t=Concourse%20CI%20on%20Kubernetes%20%28GKE%29%2c%20Part%203%3a%20TLS&u=https%3a%2f%2fblog.nono.io%2fpost%2fconcourse_on_k8s-3%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://blog.nono.io/>Brian Cunnie's Technical Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>